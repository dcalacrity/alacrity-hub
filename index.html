<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DC ALACRITY | Production Command System</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700;800;900&family=Bebas+Neue&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* ═══════════════════════════════════════════════════════════════════════
           DC ALACRITY ULTIMATE V4 - COMPLETE PRODUCTION COMMAND SYSTEM
           Futuristic Luxury Minimalist Design
           ═══════════════════════════════════════════════════════════════════════ */

        :root {
            /* ─── VOID PALETTE ─── */
            --void-pure: #000000;
            --void-deep: #030508;
            --void-soft: #0a0d12;
            --surface-1: #0f1318;
            --surface-2: #151a21;
            --surface-3: #1c222b;
            --surface-4: #242c38;
            
            /* ─── NEON SPECTRUM ─── */
            --neon-cyan: #00f0ff;
            --neon-cyan-dim: #00a8b3;
            --neon-violet: #a855f7;
            --neon-violet-dim: #7c3aed;
            --neon-gold: #fbbf24;
            --neon-emerald: #10b981;
            --neon-rose: #f43f5e;
            --neon-blue: #3b82f6;
            --neon-pink: #ec4899;
            --neon-orange: #f97316;
            
            /* ─── TEXT HIERARCHY ─── */
            --text-100: #ffffff;
            --text-90: #f1f5f9;
            --text-70: #94a3b8;
            --text-50: #64748b;
            --text-30: #475569;
            
            /* ─── BORDERS & EFFECTS ─── */
            --border-subtle: rgba(255, 255, 255, 0.04);
            --border-default: rgba(255, 255, 255, 0.08);
            --border-strong: rgba(255, 255, 255, 0.12);
            --glass-bg: rgba(15, 19, 24, 0.8);
            --glass-border: rgba(255, 255, 255, 0.06);
            
            /* ─── TYPOGRAPHY ─── */
            --font-display: 'Bebas Neue', sans-serif;
            --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
            
            /* ─── SHADOWS ─── */
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.5);
            --shadow-glow-cyan: 0 0 40px rgba(0, 240, 255, 0.15);
            --shadow-glow-rose: 0 0 40px rgba(244, 63, 94, 0.3);
            
            /* ─── TIMING ─── */
            --ease-out-expo: cubic-bezier(0.16, 1, 0.3, 1);
            
            /* ─── SPACING ─── */
            --space-xs: 4px;
            --space-sm: 8px;
            --space-md: 16px;
            --space-lg: 24px;
            --space-xl: 32px;
            --space-2xl: 48px;
        }

        /* ═══════════════════════════════════════════════════════════════════════
           RESET & BASE
           ═══════════════════════════════════════════════════════════════════════ */
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        html { font-size: 16px; -webkit-font-smoothing: antialiased; }
        body {
            font-family: var(--font-sans);
            background: var(--void-pure);
            color: var(--text-90);
            line-height: 1.5;
            overflow: hidden;
            height: 100vh;
        }
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background: 
                radial-gradient(ellipse 80% 50% at 50% -20%, rgba(0, 240, 255, 0.03), transparent),
                radial-gradient(ellipse 60% 40% at 100% 100%, rgba(168, 85, 247, 0.02), transparent);
            pointer-events: none;
            z-index: 0;
        }
        body::after {
            content: '';
            position: fixed;
            inset: 0;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.01) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.01) 1px, transparent 1px);
            background-size: 60px 60px;
            pointer-events: none;
            z-index: 0;
            opacity: 0.5;
        }

        /* ═══════════════════════════════════════════════════════════════════════
           LAYOUT
           ═══════════════════════════════════════════════════════════════════════ */
        .app {
            display: grid;
            grid-template-columns: 280px 1fr;
            height: 100vh;
            position: relative;
            z-index: 1;
        }

        /* ═══════════════════════════════════════════════════════════════════════
           SIDEBAR
           ═══════════════════════════════════════════════════════════════════════ */
        .sidebar {
            background: linear-gradient(180deg, var(--surface-1) 0%, var(--void-deep) 100%);
            border-right: 1px solid var(--border-default);
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }
        .sidebar::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 1px;
            height: 100%;
            background: linear-gradient(180deg, transparent 0%, var(--neon-cyan) 20%, var(--neon-violet) 50%, var(--neon-cyan) 80%, transparent 100%);
            opacity: 0.4;
            animation: sidebarPulse 8s ease-in-out infinite;
        }
        @keyframes sidebarPulse { 0%, 100% { opacity: 0.2; } 50% { opacity: 0.6; } }

        .brand {
            padding: var(--space-xl) var(--space-lg);
            border-bottom: 1px solid var(--border-subtle);
        }
        .brand-logo {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            margin-bottom: var(--space-xs);
        }
        .brand-mark {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--neon-cyan), var(--neon-violet));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--font-display);
            font-size: 18px;
            color: var(--void-pure);
            box-shadow: var(--shadow-glow-cyan);
        }
        .brand-name {
            font-family: var(--font-display);
            font-size: 24px;
            letter-spacing: 3px;
            color: var(--text-100);
        }
        .brand-tagline {
            font-family: var(--font-mono);
            font-size: 10px;
            color: var(--text-50);
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .nav {
            flex: 1;
            padding: var(--space-lg) 0;
            overflow-y: auto;
        }
        .nav-section { margin-bottom: var(--space-lg); }
        .nav-label {
            font-size: 10px;
            font-weight: 700;
            color: var(--text-30);
            letter-spacing: 2px;
            text-transform: uppercase;
            padding: 0 var(--space-lg) var(--space-sm);
        }
        .nav-item {
            display: flex;
            align-items: center;
            gap: var(--space-md);
            padding: var(--space-md) var(--space-lg);
            color: var(--text-50);
            cursor: pointer;
            position: relative;
            transition: all 0.3s var(--ease-out-expo);
            border-left: 2px solid transparent;
        }
        .nav-item::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, var(--neon-cyan), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .nav-item:hover { color: var(--text-90); background: rgba(255, 255, 255, 0.02); }
        .nav-item:hover::before { opacity: 0.05; }
        .nav-item.active {
            color: var(--neon-cyan);
            background: rgba(0, 240, 255, 0.05);
            border-left-color: var(--neon-cyan);
        }
        .nav-item.active::before { opacity: 0.08; }
        .nav-item.business-crm-item.active {
            color: var(--neon-gold);
            background: rgba(251, 191, 36, 0.05);
            border-left-color: var(--neon-gold);
        }
        .nav-icon {
            font-size: 18px;
            width: 24px;
            text-align: center;
            position: relative;
            z-index: 1;
        }
        .nav-text {
            font-size: 13px;
            font-weight: 500;
            position: relative;
            z-index: 1;
        }

        .project-selector {
            padding: var(--space-lg);
            background: var(--surface-2);
            border-top: 1px solid var(--border-subtle);
        }
        .project-label {
            font-size: 9px;
            font-weight: 600;
            color: var(--text-30);
            letter-spacing: 1.5px;
            text-transform: uppercase;
            margin-bottom: var(--space-sm);
        }
        .project-dropdown {
            width: 100%;
            padding: var(--space-sm) var(--space-md);
            background: var(--surface-3);
            border: 1px solid var(--border-default);
            border-radius: 6px;
            color: var(--text-100);
            font-family: var(--font-sans);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
        }
        .project-dropdown:hover { border-color: var(--neon-cyan); }
        .project-actions {
            display: flex;
            gap: var(--space-sm);
            margin-top: var(--space-sm);
        }
        .project-btn {
            flex: 1;
            padding: var(--space-sm);
            background: var(--surface-3);
            border: 1px solid var(--border-default);
            border-radius: 4px;
            color: var(--text-70);
            font-family: var(--font-mono);
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .project-btn:hover { background: var(--surface-4); color: var(--neon-cyan); border-color: var(--neon-cyan); }
        .project-btn.danger:hover { color: var(--neon-rose); border-color: var(--neon-rose); }

        /* ═══════════════════════════════════════════════════════════════════════
           MAIN CONTENT
           ═══════════════════════════════════════════════════════════════════════ */
        .main {
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--void-soft);
        }
        .command-bar {
            height: 72px;
            background: var(--surface-1);
            border-bottom: 1px solid var(--border-default);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 var(--space-xl);
        }
        .page-title {
            font-family: var(--font-display);
            font-size: 28px;
            letter-spacing: 4px;
            color: var(--text-100);
        }
        .status-group { display: flex; gap: var(--space-md); }
        .status-pill {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding: var(--space-sm) var(--space-md);
            background: var(--surface-2);
            border: 1px solid var(--border-default);
            border-radius: 20px;
            font-family: var(--font-mono);
            font-size: 11px;
            font-weight: 600;
            color: var(--text-70);
        }
        .status-pill .dot {
            width: 8px;
            height: 8px;
            background: var(--neon-emerald);
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }
        .status-pill.warning { border-color: var(--neon-rose); color: var(--neon-rose); animation: warningPulse 1s ease-in-out infinite; }
        .status-pill.warning .dot { background: var(--neon-rose); }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @keyframes warningPulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(244, 63, 94, 0.4); } 50% { box-shadow: 0 0 0 8px rgba(244, 63, 94, 0); } }

        .workspace {
            flex: 1;
            padding: var(--space-xl);
            overflow-y: auto;
        }
        .view { display: none; animation: fadeIn 0.3s ease; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* ═══════════════════════════════════════════════════════════════════════
           CARDS & COMPONENTS
           ═══════════════════════════════════════════════════════════════════════ */
        .card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            overflow: hidden;
        }
        .card-header {
            padding: var(--space-lg) var(--space-xl);
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .card-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-100);
            letter-spacing: 1px;
            text-transform: uppercase;
        }
        .card-body { padding: var(--space-xl); }
        .card-footer {
            padding: var(--space-lg) var(--space-xl);
            border-top: 1px solid var(--border-subtle);
            display: flex;
            gap: var(--space-md);
        }

        .stat-card {
            padding: var(--space-xl);
            position: relative;
            overflow: hidden;
        }
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
        }
        .stat-card.cyan::before { background: linear-gradient(90deg, var(--neon-cyan), transparent); }
        .stat-card.violet::before { background: linear-gradient(90deg, var(--neon-violet), transparent); }
        .stat-card.emerald::before { background: linear-gradient(90deg, var(--neon-emerald), transparent); }
        .stat-card.gold::before { background: linear-gradient(90deg, var(--neon-gold), transparent); }
        .stat-card.rose::before { background: linear-gradient(90deg, var(--neon-rose), transparent); }
        .stat-card.pink::before { background: linear-gradient(90deg, var(--neon-pink), transparent); }
        .stat-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-50);
            letter-spacing: 1px;
            text-transform: uppercase;
            margin-bottom: var(--space-sm);
        }
        .stat-value {
            font-family: var(--font-mono);
            font-size: 32px;
            font-weight: 700;
            color: var(--text-100);
            line-height: 1;
            margin-bottom: var(--space-xs);
        }
        .stat-sub {
            font-size: 12px;
            color: var(--text-50);
        }

        .grid { display: grid; gap: var(--space-lg); }
        .grid-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        .grid-4 { grid-template-columns: repeat(4, 1fr); }
        .grid-5 { grid-template-columns: repeat(5, 1fr); }
        .grid-6 { grid-template-columns: repeat(6, 1fr); }

        /* ═══════════════════════════════════════════════════════════════════════
           FORMS
           ═══════════════════════════════════════════════════════════════════════ */
        .form-group { margin-bottom: var(--space-lg); }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-lg); }
        .form-label {
            display: block;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-50);
            letter-spacing: 1px;
            text-transform: uppercase;
            margin-bottom: var(--space-sm);
        }
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: var(--space-md);
            background: var(--surface-2);
            border: 1px solid var(--border-default);
            border-radius: 8px;
            color: var(--text-100);
            font-family: var(--font-sans);
            font-size: 14px;
            outline: none;
            transition: all 0.2s ease;
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            border-color: var(--neon-cyan);
            box-shadow: 0 0 0 3px rgba(0, 240, 255, 0.1);
        }
        .form-textarea { min-height: 100px; resize: vertical; }
        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            cursor: pointer;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-sm);
            padding: var(--space-md) var(--space-xl);
            background: var(--surface-3);
            border: 1px solid var(--border-default);
            border-radius: 8px;
            color: var(--text-90);
            font-family: var(--font-sans);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .btn:hover { background: var(--surface-4); border-color: var(--border-strong); }
        .btn-primary {
            background: linear-gradient(135deg, var(--neon-cyan), var(--neon-cyan-dim));
            border-color: var(--neon-cyan);
            color: var(--void-pure);
        }
        .btn-primary:hover { box-shadow: var(--shadow-glow-cyan); transform: translateY(-1px); }
        .btn-gold {
            background: linear-gradient(135deg, var(--neon-gold), #d97706);
            border-color: var(--neon-gold);
            color: var(--void-pure);
        }
        .btn-gold:hover { box-shadow: 0 0 40px rgba(251, 191, 36, 0.3); transform: translateY(-1px); }
        .btn-sm { padding: var(--space-sm) var(--space-md); font-size: 12px; }

        /* ═══════════════════════════════════════════════════════════════════════
           TABLES
           ═══════════════════════════════════════════════════════════════════════ */
        .table-container { overflow-x: auto; }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: var(--space-md) var(--space-lg);
            text-align: left;
            border-bottom: 1px solid var(--border-subtle);
        }
        th {
            font-size: 10px;
            font-weight: 700;
            color: var(--text-50);
            letter-spacing: 1px;
            text-transform: uppercase;
            background: var(--surface-2);
        }
        td { font-size: 13px; color: var(--text-90); }
        tr:hover td { background: rgba(255, 255, 255, 0.02); }
        tr.over-budget td { background: rgba(244, 63, 94, 0.1); }
        .table-empty {
            text-align: center;
            color: var(--text-50);
            padding: var(--space-2xl) !important;
        }

        .tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-family: var(--font-mono);
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .tag-cyan { background: rgba(0, 240, 255, 0.15); color: var(--neon-cyan); }
        .tag-violet { background: rgba(168, 85, 247, 0.15); color: var(--neon-violet); }
        .tag-emerald { background: rgba(16, 185, 129, 0.15); color: var(--neon-emerald); }
        .tag-gold { background: rgba(251, 191, 36, 0.15); color: var(--neon-gold); }
        .tag-rose { background: rgba(244, 63, 94, 0.15); color: var(--neon-rose); }
        .tag-pink { background: rgba(236, 72, 153, 0.15); color: var(--neon-pink); }

        .delete-btn {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: 1px solid var(--border-default);
            border-radius: 6px;
            color: var(--text-50);
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s ease;
        }
        .delete-btn:hover { background: rgba(244, 63, 94, 0.1); border-color: var(--neon-rose); color: var(--neon-rose); }

        .cast-badge {
            cursor: pointer;
            background: var(--neon-cyan);
            color: var(--void-pure);
            padding: 2px 6px;
            border-radius: 3px;
            margin-right: 4px;
            font-family: var(--font-mono);
            font-size: 10px;
            display: inline-block;
            font-weight: 700;
            transition: all 0.2s var(--ease-out-expo);
            border: 1px solid transparent;
        }
        .cast-badge:hover {
            background: var(--void-pure);
            color: var(--neon-cyan);
            border-color: var(--neon-cyan);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 240, 255, 0.3);
        }

        .over-budget-badge {
            display: inline-block;
            padding: 4px 10px;
            background: rgba(244, 63, 94, 0.2);
            border: 1px solid var(--neon-rose);
            border-radius: 4px;
            color: var(--neon-rose);
            font-family: var(--font-mono);
            font-size: 10px;
            font-weight: 700;
            animation: warningPulse 1.5s ease-in-out infinite;
        }

        .editable { cursor: pointer; }
        .editable:hover { background: rgba(0, 240, 255, 0.1); border-radius: 4px; }
        .editable-input {
            width: 100%;
            padding: var(--space-sm);
            background: var(--surface-3);
            border: 1px solid var(--neon-cyan);
            border-radius: 4px;
            color: var(--text-100);
            font-family: var(--font-mono);
            font-size: 13px;
            outline: none;
        }

        /* ═══════════════════════════════════════════════════════════════════════
           RESULT BOX
           ═══════════════════════════════════════════════════════════════════════ */
        .result-box {
            background: var(--surface-2);
            border: 1px solid var(--border-default);
            border-radius: 12px;
            padding: var(--space-xl);
            font-family: var(--font-mono);
            font-size: 13px;
            line-height: 1.8;
            white-space: pre-wrap;
            color: var(--text-70);
            min-height: 200px;
        }
        .result-box.success { border-color: var(--neon-emerald); background: rgba(16, 185, 129, 0.05); }

        /* ═══════════════════════════════════════════════════════════════════════
           ACTIVITY LOG
           ═══════════════════════════════════════════════════════════════════════ */
        .log-container {
            max-height: 300px;
            overflow-y: auto;
        }
        .log-entry {
            display: flex;
            gap: var(--space-md);
            padding: var(--space-sm) 0;
            border-bottom: 1px solid var(--border-subtle);
            font-size: 12px;
        }
        .log-time {
            font-family: var(--font-mono);
            color: var(--text-50);
            flex-shrink: 0;
        }
        .log-msg { color: var(--text-70); }

        /* ═══════════════════════════════════════════════════════════════════════
           MODALS
           ═══════════════════════════════════════════════════════════════════════ */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal {
            background: var(--surface-1);
            border: 1px solid var(--border-default);
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(20px);
            transition: transform 0.3s var(--ease-out-expo);
        }
        .modal-overlay.active .modal { transform: translateY(0); }
        .modal-header {
            padding: var(--space-lg) var(--space-xl);
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .modal-title { font-size: 16px; font-weight: 700; color: var(--text-100); }
        .modal-close {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: 1px solid var(--border-default);
            border-radius: 8px;
            color: var(--text-50);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 18px;
        }
        .modal-close:hover { background: var(--surface-3); color: var(--text-100); }
        .modal-body { padding: var(--space-xl); }
        .modal-footer {
            padding: var(--space-lg) var(--space-xl);
            border-top: 1px solid var(--border-subtle);
            display: flex;
            gap: var(--space-md);
            justify-content: flex-end;
        }

        /* ═══════════════════════════════════════════════════════════════════════
           CRM KANBAN
           ═══════════════════════════════════════════════════════════════════════ */
        .kanban-wrapper {
            display: flex;
            gap: var(--space-lg);
            height: calc(100vh - 200px);
            overflow-x: auto;
            padding-bottom: var(--space-lg);
        }
        .kanban-column {
            min-width: 300px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
        }
        .kanban-column-header {
            padding: var(--space-md) var(--space-lg);
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .kanban-column-title {
            font-size: 12px;
            font-weight: 700;
            color: var(--text-100);
            letter-spacing: 1px;
            text-transform: uppercase;
        }
        .kanban-column-count {
            background: var(--surface-3);
            padding: 2px 8px;
            border-radius: 10px;
            font-family: var(--font-mono);
            font-size: 11px;
            color: var(--text-50);
        }
        .kanban-column-body {
            flex: 1;
            padding: var(--space-md);
            overflow-y: auto;
            min-height: 100px;
        }
        .kanban-card {
            background: var(--surface-2);
            border: 1px solid var(--border-default);
            border-radius: 8px;
            padding: var(--space-md);
            margin-bottom: var(--space-sm);
            cursor: grab;
            position: relative;
            transition: all 0.2s ease;
        }
        .kanban-card:hover { border-color: var(--border-strong); transform: translateY(-2px); }
        .kanban-card.dragging { opacity: 0.5; }
        .kanban-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 3px;
            height: 100%;
            border-radius: 8px 0 0 8px;
        }
        .kanban-card.interest-cinema::before { background: var(--neon-pink); }
        .kanban-card.interest-vr::before { background: var(--neon-cyan); }
        .kanban-card.interest-cyber::before { background: var(--neon-violet); }
        .kanban-card.interest-video::before { background: var(--neon-emerald); }
        .kanban-card.interest-custom::before { background: var(--neon-gold); }
        /* Production CRM interest types */
        .kanban-card.interest-talent::before { background: var(--neon-pink); }
        .kanban-card.interest-vendor::before { background: var(--neon-blue); }
        .kanban-card.interest-sponsor::before { background: var(--neon-gold); }
        .kanban-card.interest-investor::before { background: var(--neon-emerald); }
        .kanban-card-name { font-weight: 600; color: var(--text-100); margin-bottom: 4px; }
        .kanban-card-phone { font-family: var(--font-mono); font-size: 12px; color: var(--text-50); margin-bottom: 8px; }
        .kanban-card-value { font-family: var(--font-mono); font-size: 14px; font-weight: 700; color: var(--neon-emerald); }
        .kanban-card-actions {
            position: absolute;
            top: 8px;
            right: 8px;
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .kanban-card:hover .kanban-card-actions { opacity: 1; }
        .kanban-card-btn {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--surface-3);
            border: 1px solid var(--border-default);
            border-radius: 4px;
            color: var(--text-50);
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s ease;
        }
        .kanban-card-btn:hover { color: var(--text-100); border-color: var(--text-100); }
        .kanban-card-btn.del:hover { color: var(--neon-rose); border-color: var(--neon-rose); }
        .kanban-card-btn.call:hover { color: var(--neon-emerald); border-color: var(--neon-emerald); }

        /* ═══════════════════════════════════════════════════════════════════════
           CRM DIALER HUD
           ═══════════════════════════════════════════════════════════════════════ */
        .dialer-grid { display: grid; grid-template-columns: 2fr 1fr; gap: var(--space-xl); height: calc(100vh - 200px); }
        .dialer-main {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: var(--space-2xl);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        .dialer-main::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--neon-cyan), transparent);
            animation: scanline 3s infinite linear;
        }
        @keyframes scanline { 0% { top: 0; } 100% { top: 100%; } }
        .dialer-waiting { text-align: center; color: var(--text-50); }
        .dialer-waiting-icon { font-size: 48px; margin-bottom: var(--space-lg); opacity: 0.5; }
        .dialer-name { font-family: var(--font-display); font-size: 48px; letter-spacing: 2px; color: var(--text-100); margin-bottom: var(--space-sm); }
        .dialer-phone { font-family: var(--font-mono); font-size: 18px; color: var(--neon-cyan); margin-bottom: var(--space-xl); }
        .dialer-script {
            width: 100%;
            max-width: 600px;
            background: rgba(0, 0, 0, 0.3);
            border-left: 4px solid var(--neon-cyan);
            padding: var(--space-lg);
            border-radius: 0 8px 8px 0;
            color: var(--text-70);
            font-size: 15px;
            line-height: 1.7;
            margin-bottom: var(--space-xl);
            white-space: pre-wrap;
        }
        .dialer-controls { display: flex; gap: var(--space-lg); }
        .dialer-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: all 0.2s ease;
        }
        .dialer-btn:hover { transform: scale(1.1); }
        .dialer-btn.call { background: var(--neon-emerald); color: var(--void-pure); }
        .dialer-btn.skip { background: var(--surface-4); color: var(--text-70); }
        .dialer-btn.done { background: var(--neon-cyan); color: var(--void-pure); }
        .dialer-queue-panel {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            display: flex;
            flex-direction: column;
        }
        .dialer-queue-header {
            padding: var(--space-lg);
            border-bottom: 1px solid var(--border-subtle);
            font-size: 12px;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: var(--text-100);
        }
        .dialer-queue {
            flex: 1;
            padding: var(--space-md);
            overflow-y: auto;
        }
        .dialer-queue-item {
            padding: var(--space-md);
            border-radius: 8px;
            margin-bottom: var(--space-sm);
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }
        .dialer-queue-item:hover { background: var(--surface-2); }
        .dialer-queue-item.active { background: var(--surface-3); border-color: var(--neon-cyan); }

        /* ═══════════════════════════════════════════════════════════════════════
           SCRIPT BREAKDOWN
           ═══════════════════════════════════════════════════════════════════════ */
        .breakdown-header {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-lg);
            margin-bottom: var(--space-xl);
        }
        .breakdown-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-md);
            background: var(--surface-2);
            padding: var(--space-lg);
            border-radius: 12px;
            margin-bottom: var(--space-xl);
        }
        .breakdown-stat-label {
            font-size: 10px;
            color: var(--text-50);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 4px;
        }
        .breakdown-stat-input {
            background: transparent;
            border: none;
            color: var(--text-100);
            font-family: var(--font-mono);
            font-size: 16px;
            font-weight: 700;
            width: 100%;
            outline: none;
        }
        .breakdown-actions {
            display: flex;
            gap: var(--space-md);
            margin-bottom: var(--space-xl);
        }
        .breakdown-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-lg);
        }
        .breakdown-category {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: var(--space-lg);
            position: relative;
            overflow: hidden;
        }
        .breakdown-category::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
        }
        .breakdown-category.cat-cast::before { background: var(--neon-rose); }
        .breakdown-category.cat-stunts::before { background: var(--neon-orange); }
        .breakdown-category.cat-extras::before { background: var(--neon-gold); }
        .breakdown-category.cat-vfx::before { background: var(--neon-cyan); }
        .breakdown-category.cat-props::before { background: var(--neon-violet); }
        .breakdown-category.cat-vehicles::before { background: var(--neon-pink); }
        .breakdown-category.cat-wardrobe::before { background: #8b5cf6; }
        .breakdown-category.cat-makeup::before { background: #f472b6; }
        .breakdown-category.cat-sound::before { background: #a16207; }
        .breakdown-category.cat-special-equip::before { background: var(--neon-cyan); }
        .breakdown-category.cat-prod-notes::before { background: var(--text-50); }
        .breakdown-category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-md);
            padding-bottom: var(--space-md);
            border-bottom: 1px solid var(--border-subtle);
        }
        .breakdown-category-title {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }
        .breakdown-category-icon { font-size: 18px; }
        .breakdown-category-name {
            font-size: 12px;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
        }
        .breakdown-category-label {
            font-size: 10px;
            color: var(--text-50);
            font-style: italic;
        }
        .breakdown-elements { min-height: 40px; margin-bottom: var(--space-md); }
        .breakdown-element {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--surface-2);
            padding: var(--space-sm) var(--space-md);
            border-radius: 6px;
            margin-bottom: var(--space-xs);
        }
        .breakdown-element-text { font-size: 13px; color: var(--text-90); }
        .breakdown-element-del {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            color: var(--text-50);
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        .breakdown-element-del:hover { background: rgba(244, 63, 94, 0.1); color: var(--neon-rose); }
        .breakdown-add {
            display: flex;
            gap: var(--space-sm);
        }
        .breakdown-add-input {
            flex: 1;
            padding: var(--space-sm) var(--space-md);
            background: var(--surface-2);
            border: 1px solid var(--border-default);
            border-radius: 6px;
            color: var(--text-100);
            font-size: 13px;
            outline: none;
        }
        .breakdown-add-input:focus { border-color: var(--neon-cyan); }
        .breakdown-add-btn {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--neon-cyan);
            border: none;
            border-radius: 6px;
            color: var(--void-pure);
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .breakdown-add-btn:hover { transform: scale(1.05); }

        /* ═══════════════════════════════════════════════════════════════════════
           PRINT STYLES FOR SCRIPT BREAKDOWN - WHITE BACKGROUND
           ═══════════════════════════════════════════════════════════════════════ */
        @media print {
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            body {
                background: #ffffff !important;
                color: #000000 !important;
                font-size: 11pt;
            }
            body::before, body::after { display: none !important; }
            .app { display: block !important; background: #ffffff !important; }
            .sidebar, .command-bar, .nav, .project-selector { display: none !important; }
            .main { display: block !important; background: #ffffff !important; }
            .workspace { padding: 20px !important; overflow: visible !important; background: #ffffff !important; }
            .view { display: none !important; }
            #view-breakdown { display: block !important; background: #ffffff !important; }
            .breakdown-actions { display: none !important; }
            .breakdown-add { display: none !important; }
            .breakdown-element-del { display: none !important; }
            
            .card, .breakdown-category {
                background: #ffffff !important;
                border: 1px solid #cccccc !important;
                box-shadow: none !important;
                break-inside: avoid;
            }
            .breakdown-header {
                border-bottom: 2px solid #000000;
                padding-bottom: 15px;
                margin-bottom: 20px;
            }
            .breakdown-stats {
                background: #f5f5f5 !important;
                border: 1px solid #cccccc !important;
            }
            .breakdown-stat-label { color: #333333 !important; }
            .breakdown-stat-input { color: #000000 !important; border: none !important; }
            .form-input, .form-select {
                background: #ffffff !important;
                border: none !important;
                border-bottom: 1px solid #cccccc !important;
                color: #000000 !important;
                padding: 4px 0 !important;
            }
            .form-label { color: #666666 !important; }
            .breakdown-category {
                background: #ffffff !important;
            }
            .breakdown-category::before { 
                height: 4px !important; 
                opacity: 1 !important;
            }
            .breakdown-category-header {
                border-bottom: 1px solid #cccccc !important;
            }
            .breakdown-category-name { color: #000000 !important; }
            .breakdown-category-label { color: #666666 !important; }
            .breakdown-element {
                background: #f9f9f9 !important;
                border: 1px solid #dddddd !important;
            }
            .breakdown-element-text { color: #000000 !important; }
            .breakdown-grid {
                display: grid !important;
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 15px !important;
            }
            
            /* Print header */
            .print-header {
                display: block !important;
                text-align: center;
                margin-bottom: 20px;
                padding-bottom: 15px;
                border-bottom: 3px double #000000;
                background: #ffffff !important;
            }
            .print-header h1 {
                font-size: 24pt;
                font-weight: 900;
                margin-bottom: 5px;
                color: #000000 !important;
            }
            .print-header .subtitle {
                font-size: 10pt;
                color: #666666 !important;
                letter-spacing: 3px;
            }
            
            /* Scene header box - WHITE background for print */
            .print-scene-header {
                display: flex !important;
                background: #f0f0f0 !important;
                color: #000000 !important;
                padding: 15px 20px;
                margin-bottom: 20px;
                font-weight: 700;
                border: 2px solid #000000 !important;
            }
        }
        .print-header, .print-scene-header { display: none; }

        /* ═══════════════════════════════════════════════════════════════════════
           STRIPBOARD SHOOTING SCHEDULE
           ═══════════════════════════════════════════════════════════════════════ */
        .stripboard-container {
            display: flex;
            flex-direction: column;
            gap: var(--space-lg);
            height: 100%;
        }
        .stripboard-toolbar {
            display: flex;
            gap: var(--space-md);
            align-items: center;
            flex-wrap: wrap;
        }
        .stripboard {
            flex: 1;
            overflow-y: auto;
            background: var(--surface-1);
            border: 1px solid var(--border-default);
            border-radius: 12px;
            padding: var(--space-lg);
        }
        .strip {
            background: var(--surface-2);
            border: 1px solid var(--border-default);
            border-radius: 8px;
            padding: var(--space-md);
            margin-bottom: var(--space-sm);
            cursor: grab;
            transition: all 0.2s ease;
        }
        .strip:hover {
            background: var(--surface-3);
            border-color: var(--border-strong);
            transform: translateX(4px);
        }
        .strip.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }
        .strip.dragover {
            border-color: var(--neon-cyan);
            background: rgba(0, 240, 255, 0.1);
        }
        .strip.expanded {
            padding-bottom: var(--space-lg);
        }
        
        /* Strip main row */
        .strip-main {
            display: grid;
            grid-template-columns: 50px 80px 60px 1fr 120px 80px 60px 60px;
            gap: var(--space-md);
            align-items: center;
            font-size: 12px;
        }
        
        /* Strip colors based on INT/EXT and DAY/NIGHT */
        .strip.day-int { border-left: 4px solid #ffffff; }
        .strip.day-ext { border-left: 4px solid var(--neon-gold); }
        .strip.night-int { border-left: 4px solid var(--neon-blue); }
        .strip.night-ext { border-left: 4px solid var(--neon-emerald); }
        
        .strip-scene { font-family: var(--font-mono); font-weight: 700; color: var(--text-100); }
        .strip-intext { font-family: var(--font-mono); font-size: 10px; color: var(--text-50); }
        .strip-daynight { font-family: var(--font-mono); font-size: 10px; }
        .strip-location { color: var(--text-90); font-weight: 600; }
        .strip-description { color: var(--text-70); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .strip-cast { font-family: var(--font-mono); font-size: 10px; color: var(--neon-violet); }
        .strip-pages { font-family: var(--font-mono); color: var(--neon-cyan); font-weight: 600; }
        .strip-actions {
            display: flex;
            gap: var(--space-sm);
            align-items: center;
        }
        .strip-expand {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--neon-cyan);
            transition: all 0.2s ease;
            font-size: 10px;
        }
        .strip-expand:hover { 
            color: var(--text-100);
            background: rgba(0, 240, 255, 0.1);
            border-radius: 4px;
        }
        .strip-handle {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-50);
            transition: all 0.2s ease;
        }
        .strip-handle:hover { color: var(--neon-rose); }
        
        /* Breakdown details section */
        .strip-breakdown {
            margin-top: var(--space-lg);
            padding-top: var(--space-lg);
            border-top: 1px solid var(--border-subtle);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-md);
        }
        .strip-breakdown-category {
            background: var(--surface-3);
            border-radius: 6px;
            padding: var(--space-sm) var(--space-md);
        }
        .strip-breakdown-label {
            font-family: var(--font-mono);
            font-size: 10px;
            font-weight: 700;
            color: var(--text-50);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: var(--space-xs);
        }
        .strip-breakdown-items {
            font-size: 12px;
            color: var(--text-90);
            line-height: 1.6;
        }
        
        /* Day break strip */
        .daybreak {
            background: linear-gradient(90deg, var(--surface-4), var(--surface-3));
            border: 1px solid var(--border-strong);
            border-radius: 8px;
            padding: var(--space-md) var(--space-lg);
            margin: var(--space-lg) 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: var(--font-mono);
            font-weight: 700;
        }
        .daybreak-label { color: var(--text-100); font-size: 14px; letter-spacing: 1px; }
        .daybreak-info { color: var(--text-70); font-size: 12px; display: flex; gap: var(--space-xl); }
        .daybreak-pages { color: var(--neon-cyan); }
        .daybreak-date { color: var(--neon-gold); }
        
        /* Banner strip */
        .banner {
            background: rgba(168, 85, 247, 0.1);
            border: 1px dashed rgba(168, 85, 247, 0.4);
            border-radius: 8px;
            padding: var(--space-md) var(--space-lg);
            margin: var(--space-md) 0;
            font-family: var(--font-mono);
            color: var(--neon-violet);
            text-align: center;
            font-weight: 600;
        }
        
        /* Scene modal */
        .scene-form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-md);
        }
        .scene-form-full {
            grid-column: 1 / -1;
        }
        
        /* Export preview */
        .schedule-export {
            background: var(--surface-1);
            border: 1px solid var(--border-default);
            border-radius: 12px;
            padding: var(--space-xl);
            font-family: var(--font-mono);
            font-size: 12px;
            line-height: 1.8;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .schedule-day-header {
            font-weight: 700;
            color: var(--neon-cyan);
            margin-top: var(--space-lg);
            margin-bottom: var(--space-sm);
            padding-bottom: var(--space-sm);
            border-bottom: 1px solid var(--border-default);
        }
        .schedule-scene-line {
            color: var(--text-90);
            padding: 2px 0;
        }

        /* ═══════════════════════════════════════════════════════════════════════
           UTILITIES
           ═══════════════════════════════════════════════════════════════════════ */
        .mt-sm { margin-top: var(--space-sm); }
        .mt-md { margin-top: var(--space-md); }
        .mt-lg { margin-top: var(--space-lg); }
        .mt-xl { margin-top: var(--space-xl); }
        .mb-sm { margin-bottom: var(--space-sm); }
        .mb-md { margin-bottom: var(--space-md); }
        .mb-lg { margin-bottom: var(--space-lg); }
        .text-cyan { color: var(--neon-cyan); }
        .text-violet { color: var(--neon-violet); }
        .text-emerald { color: var(--neon-emerald); }
        .text-gold { color: var(--neon-gold); }
        .text-rose { color: var(--neon-rose); }
        .text-muted { color: var(--text-50); }
        .font-mono { font-family: var(--font-mono); }
        .font-bold { font-weight: 700; }
        .hidden { display: none !important; }

        /* Business CRM specific styling */
        .business-crm-header {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(168, 85, 247, 0.05));
            border: 1px solid rgba(251, 191, 36, 0.3);
        }
        .business-crm-badge {
            display: inline-block;
            padding: 4px 12px;
            background: linear-gradient(135deg, var(--neon-gold), #d97706);
            border-radius: 4px;
            color: var(--void-pure);
            font-family: var(--font-mono);
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--surface-1); }
        ::-webkit-scrollbar-thumb { background: var(--surface-4); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-30); }
    </style>
</head>
<body>

<div id="login-overlay" style="position:fixed;inset:0;background:#000;z-index:9999;display:flex;align-items:center;justify-content:center;flex-direction:column;transition:opacity 0.5s ease;">
    <div style="font-family:'Bebas Neue';font-size:64px;color:#fff;letter-spacing:4px;margin-bottom:20px;">
        DC <span style="color:#00f0ff;">ALACRITY</span>
    </div>
    <div style="font-family:'Inter';color:#94a3b8;margin-bottom:40px;letter-spacing:2px;font-size:12px;">SECURE CLOUD ENVIRONMENT // V5.0</div>
    <button id="btn-login" style="padding:16px 32px;background:linear-gradient(135deg,#00f0ff,#00a8b3);border:none;border-radius:8px;color:#000;font-weight:700;font-size:14px;cursor:pointer;letter-spacing:1px;font-family:'Inter';">
        AUTHENTICATE IDENTITY
    </button>
    <div id="login-status" style="margin-top:20px;color:#ef4444;font-family:'JetBrains Mono';font-size:11px;"></div>
</div>

    <div class="app">
        <aside class="sidebar">
            <div class="brand">
                <div class="brand-logo">
                    <div class="brand-mark">DC</div>
                    <div class="brand-name">ALACRITY</div>
                </div>
                <div class="brand-tagline">Production Command System</div>
            </div>

            <nav class="nav">
                <div class="nav-section">
                    <div class="nav-label">Overview</div>
                    <div class="nav-item active" data-view="dashboard">
                        <span class="nav-icon">◈</span>
                        <span class="nav-text">Command Center</span>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-label">Production</div>
                    <div class="nav-item" data-view="days">
                        <span class="nav-icon">◉</span>
                        <span class="nav-text">Shooting Days</span>
                    </div>
                    <div class="nav-item" data-view="schedule">
                        <span class="nav-icon">▦</span>
                        <span class="nav-text">Shooting Schedule</span>
                    </div>
                    <div class="nav-item" data-view="castcrew">
                        <span class="nav-icon">👥</span>
                        <span class="nav-text">Cast & Crew</span>
                    </div>
                    <div class="nav-item" data-view="tech">
                        <span class="nav-icon">◎</span>
                        <span class="nav-text">Tech Inventory</span>
                    </div>
                    <div class="nav-item" data-view="vault">
                        <span class="nav-icon">◐</span>
                        <span class="nav-text">The Vault</span>
                    </div>
                    <div class="nav-item" data-view="breakdown">
                        <span class="nav-icon">◧</span>
                        <span class="nav-text">Script Breakdown</span>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-label">Financial</div>
                    <div class="nav-item" data-view="payroll">
                        <span class="nav-icon">◆</span>
                        <span class="nav-text">Payroll Engine</span>
                    </div>
                    <div class="nav-item" data-view="budget">
                        <span class="nav-icon">◇</span>
                        <span class="nav-text">Budget Ledger</span>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-label">Production CRM</div>
                    <div class="nav-item" data-view="prod-pipeline">
                        <span class="nav-icon">▣</span>
                        <span class="nav-text">Pipeline</span>
                    </div>
                    <div class="nav-item" data-view="prod-dialer">
                        <span class="nav-icon">▤</span>
                        <span class="nav-text">Dialer</span>
                    </div>
                    <div class="nav-item" data-view="prod-intel">
                        <span class="nav-icon">▥</span>
                        <span class="nav-text">Intel</span>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-label" style="color: var(--neon-gold);">Business CRM</div>
                    <div class="nav-item business-crm-item" data-view="biz-pipeline">
                        <span class="nav-icon">◈</span>
                        <span class="nav-text">Pipeline</span>
                    </div>
                    <div class="nav-item business-crm-item" data-view="biz-dialer">
                        <span class="nav-icon">◉</span>
                        <span class="nav-text">Dialer</span>
                    </div>
                    <div class="nav-item business-crm-item" data-view="biz-intel">
                        <span class="nav-icon">◎</span>
                        <span class="nav-text">Intel</span>
                    </div>
                </div>
            </nav>

            <div class="project-selector">
                <div class="project-label">Active Production</div>
                <select class="project-dropdown" id="project-select" onchange="Productions.load()"></select>
                <div class="project-actions">
                    <button class="project-btn" onclick="Productions.showNew()">+ New</button>
                    <button class="project-btn" onclick="Productions.rename()">Rename</button>
                    <button class="project-btn danger" onclick="Productions.delete()">Delete</button>
                </div>
            </div>
        </aside>

        <main class="main">
            <header class="command-bar">
                <h1 class="page-title" id="page-title">COMMAND CENTER</h1>
                <div class="status-group">
                    <div class="status-pill" id="budget-status">
                        <span class="dot"></span>
                        <span id="budget-status-text">ON BUDGET</span>
                    </div>
                    <div class="status-pill">
                        <span class="dot"></span>
                        AUTO-SAVE
                    </div>
                </div>
            </header>

            <div class="workspace">
                <div id="view-dashboard" class="view active">
                    <div class="grid grid-6 mb-lg">
                        <div class="card stat-card cyan">
                            <div class="stat-label">Shoot Days</div>
                            <div class="stat-value" id="stat-days">0</div>
                            <div class="stat-sub">Scheduled</div>
                        </div>
                        <div class="card stat-card violet">
                            <div class="stat-label">Vault Assets</div>
                            <div class="stat-value" id="stat-vault">0</div>
                            <div class="stat-sub">Files Logged</div>
                        </div>
                        <div class="card stat-card emerald">
                            <div class="stat-label">Tech Items</div>
                            <div class="stat-value" id="stat-tech">0</div>
                            <div class="stat-sub">Equipment</div>
                        </div>
                        <div class="card stat-card gold">
                            <div class="stat-label">Budget Left</div>
                            <div class="stat-value" id="stat-budget">$0</div>
                            <div class="stat-sub">Available</div>
                        </div>
                        <div class="card stat-card pink">
                            <div class="stat-label">Prod Pipeline</div>
                            <div class="stat-value" id="stat-prod-pipeline">$0</div>
                            <div class="stat-sub">Potential</div>
                        </div>
                        <div class="card stat-card rose" id="over-budget-card" style="display: none;">
                            <div class="stat-label">Over Budget</div>
                            <div class="stat-value" id="stat-over">$0</div>
                            <div class="stat-sub">Categories</div>
                        </div>
                    </div>

                    <div class="grid grid-2 mb-lg">
                        <div class="card" id="hot-cost-card">
                            <div class="card-header">
                                <div class="card-title">Hot Cost Summary</div>
                                <span id="hot-cost-badge"></span>
                            </div>
                            <div class="card-body">
                                <div class="grid grid-3">
                                    <div>
                                        <div class="stat-label">Total Budget</div>
                                        <div class="stat-value" style="font-size: 24px;" id="hot-budget">$0</div>
                                    </div>
                                    <div>
                                        <div class="stat-label">Spent + Committed</div>
                                        <div class="stat-value text-gold" style="font-size: 24px;" id="hot-spent">$0</div>
                                    </div>
                                    <div>
                                        <div class="stat-label">Payroll Cost</div>
                                        <div class="stat-value text-violet" style="font-size: 24px;" id="hot-payroll">$0</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card business-crm-header">
                            <div class="card-header">
                                <div class="card-title">Business CRM <span class="business-crm-badge">GLOBAL</span></div>
                            </div>
                            <div class="card-body">
                                <div class="grid grid-3">
                                    <div>
                                        <div class="stat-label">Pipeline Value</div>
                                        <div class="stat-value text-gold" style="font-size: 24px;" id="biz-pipeline-value">$0</div>
                                    </div>
                                    <div>
                                        <div class="stat-label">Total Revenue</div>
                                        <div class="stat-value text-emerald" style="font-size: 24px;" id="biz-revenue-value">$0</div>
                                    </div>
                                    <div>
                                        <div class="stat-label">Active Leads</div>
                                        <div class="stat-value text-cyan" style="font-size: 24px;" id="biz-leads-count">0</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Activity Log</div>
                        </div>
                        <div class="card-body">
                            <div class="log-container" id="activity-log"></div>
                        </div>
                    </div>
                </div>

                <div id="view-days" class="view">
                    <div class="card mb-lg">
                        <div class="card-header">
                            <div class="card-title">Schedule Shoot Day</div>
                        </div>
                        <div class="card-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Date</label>
                                    <input type="date" class="form-input" id="day-date">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Call Time</label>
                                    <input type="time" class="form-input" id="day-call" value="07:00">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Wrap Time (Est)</label>
                                    <input type="time" class="form-input" id="day-wrap" value="19:00">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Location</label>
                                    <input type="text" class="form-input" id="day-location" placeholder="Studio A / On Location">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Notes</label>
                                <textarea class="form-textarea" id="day-notes" placeholder="Scene numbers, special requirements..."></textarea>
                            </div>
                        </div>
                        <div class="card-footer">
                            <button class="btn btn-primary" onclick="Days.add()">+ Add Shoot Day</button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Scheduled Days</div>
                            <button class="btn btn-sm" onclick="Days.exportCSV()">Export CSV</button>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Call</th>
                                        <th>Wrap</th>
                                        <th>Location</th>
                                        <th>Notes</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="table-days"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="view-tech" class="view">
                    <div class="card mb-lg">
                        <div class="card-header">
                            <div class="card-title">Add Equipment</div>
                        </div>
                        <div class="card-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Item Name</label>
                                    <input type="text" class="form-input" id="tech-name" placeholder="RED Komodo 6K">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Category</label>
                                    <select class="form-select" id="tech-category">
                                        <option value="Camera">Camera</option>
                                        <option value="Lens">Lens</option>
                                        <option value="Audio">Audio</option>
                                        <option value="Lighting">Lighting</option>
                                        <option value="Grip">Grip</option>
                                        <option value="Storage">Storage</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Serial / ID</label>
                                    <input type="text" class="form-input" id="tech-serial" placeholder="SN-12345">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Owner</label>
                                    <select class="form-select" id="tech-owner">
                                        <option value="Production">Production</option>
                                        <option value="Rental">Rental</option>
                                        <option value="Personal">Personal</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer">
                            <button class="btn btn-primary" onclick="Tech.add()">+ Add Item</button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Equipment List</div>
                            <button class="btn btn-sm" onclick="Tech.exportCSV()">Export CSV</button>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Item</th>
                                        <th>Category</th>
                                        <th>Serial</th>
                                        <th>Owner</th>
                                        <th>Status</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="table-tech"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="view-vault" class="view">
                    <div class="card mb-lg">
                        <div class="card-header">
                            <div class="card-title">Log Asset</div>
                        </div>
                        <div class="card-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Filename</label>
                                    <input type="text" class="form-input" id="vault-filename" placeholder="A001_C001_0101AB.mov">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Scene / Take</label>
                                    <input type="text" class="form-input" id="vault-scene" placeholder="Scene 1 / Take 3">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Camera</label>
                                    <input type="text" class="form-input" id="vault-camera" placeholder="A-Cam">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Storage Location</label>
                                    <input type="text" class="form-input" id="vault-storage" placeholder="SSD-001 / Cloud">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Notes</label>
                                <input type="text" class="form-input" id="vault-notes" placeholder="Circle take, best performance...">
                            </div>
                        </div>
                        <div class="card-footer">
                            <button class="btn btn-primary" onclick="Vault.add()">+ Log Asset</button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Asset Log</div>
                            <button class="btn btn-sm" onclick="Vault.exportCSV()">Export CSV</button>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Filename</th>
                                        <th>Scene/Take</th>
                                        <th>Camera</th>
                                        <th>Storage</th>
                                        <th>Notes</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="table-vault"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="view-breakdown" class="view">
                    <div class="print-header">
                        <h1 id="print-title">SCRIPT BREAKDOWN</h1>
                        <div class="subtitle">PRODUCTION BREAKDOWN SHEET</div>
                    </div>
                    <div class="print-scene-header" id="print-scene-header"></div>
                    
                    <div class="breakdown-stats">
                        <div>
                            <div class="breakdown-stat-label">Sheet #</div>
                            <input type="text" class="breakdown-stat-input" id="bd-sheet" value="1">
                        </div>
                        <div>
                            <div class="breakdown-stat-label">Pages</div>
                            <input type="text" class="breakdown-stat-input" id="bd-pages" value="1">
                        </div>
                        <div>
                            <div class="breakdown-stat-label">Date</div>
                            <input type="text" class="breakdown-stat-input" id="bd-date">
                        </div>
                    </div>

                    <div class="card mb-lg">
                        <div class="card-header">
                            <div class="card-title">Scene Information</div>
                        </div>
                        <div class="card-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Production</label>
                                    <input type="text" class="form-input" id="bd-project" value="SIDEQUEST">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Scene #</label>
                                    <input type="text" class="form-input" id="bd-scene" value="1">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">INT/EXT</label>
                                    <select class="form-select" id="bd-intext">
                                        <option value="INT">INT</option>
                                        <option value="EXT">EXT</option>
                                        <option value="INT/EXT">INT/EXT</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Day/Night</label>
                                    <select class="form-select" id="bd-daynight">
                                        <option value="DAY">DAY</option>
                                        <option value="NIGHT">NIGHT</option>
                                        <option value="DAWN">DAWN</option>
                                        <option value="DUSK">DUSK</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Location</label>
                                    <input type="text" class="form-input" id="bd-location" placeholder="WAREHOUSE">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Description</label>
                                <textarea class="form-textarea" id="bd-description" placeholder="Brief scene description..."></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="breakdown-grid" id="breakdown-categories"></div>
                </div>

                
                <div id="view-castcrew" class="view">
                    <div class="grid grid-2 mb-lg">
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">Cast Members</div>
                                <button class="btn btn-sm btn-primary" onclick="CastCrew.addMember('cast')">+ Add Cast</button>
                            </div>
                            <div class="card-body">
                                <div id="cast-list"></div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">Crew Members</div>
                                <button class="btn btn-sm btn-primary" onclick="CastCrew.addMember('crew')">+ Add Crew</button>
                            </div>
                            <div class="card-body">
                                <div id="crew-list"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="view-schedule" class="view">
                    <div class="stripboard-container">
                        <div class="stripboard-toolbar">
                            <button class="btn btn-primary" onclick="Schedule.addScene()">+ Add Scene</button>
                            
                            <button class="btn btn-gold" onclick="ScriptImporter.run()">📥 Import Script</button>
                            <button class="btn" onclick="Schedule.exportCreamHatPDF()">📄 PDF (Setup Style)</button>
                            <button class="btn" onclick="Schedule.addDayBreak()">+ Day Break</button>
                            <button class="btn" onclick="Schedule.addBanner()">+ Banner</button>
                            <button class="btn btn-primary" onclick="Schedule.autoSort()">⚡ Auto Sort</button>
                            <button class="btn" onclick="Schedule.importFromBreakdown()">📋 Import from Breakdown</button>
                            <button class="btn" onclick="Schedule.showAnalysis()">📊 Analysis</button>
                            <button class="btn" onclick="Schedule.exportSchedule()">📄 Export TXT</button>
                            <button class="btn btn-primary" onclick="Schedule.exportSchedulePDF()">📄 Export PDF</button>
                            <div style="flex: 1;"></div>
                            <button class="btn btn-sm" onclick="Schedule.expandAll()">Expand All</button>
                            <button class="btn btn-sm" onclick="Schedule.collapseAll()">Collapse All</button>
                            <div class="stat-value" style="font-size: 18px; color: var(--neon-cyan);" id="schedule-total-pages">0 pages</div>
                        </div>

                        <div class="stripboard" id="stripboard-container">
                            <div style="text-align: center; color: var(--text-50); padding: var(--space-2xl);">
                                No scenes added yet. Click "+ Add Scene" or import from Script Breakdown.
                            </div>
                        </div>
                    </div>
                </div>

                <div id="view-payroll" class="view">
                    <div class="grid grid-2 mb-lg">
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">Timecard Calculator</div>
                            </div>
                            <div class="card-body">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Name</label>
                                        <input type="text" class="form-input" id="pay-name" placeholder="John Smith">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Position</label>
                                        <input type="text" class="form-input" id="pay-position" placeholder="Gaffer">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Department</label>
                                        <select class="form-select" id="pay-dept">
                                            <option value="Camera">Camera</option>
                                            <option value="Grip">Grip</option>
                                            <option value="Electric">Electric</option>
                                            <option value="Sound">Sound</option>
                                            <option value="Art">Art</option>
                                            <option value="Wardrobe">Wardrobe</option>
                                            <option value="HMU">Hair/Makeup</option>
                                            <option value="Production">Production</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Day Rate ($)</label>
                                        <input type="number" class="form-input" id="pay-rate" placeholder="500">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Guarantee (hrs)</label>
                                        <input type="number" class="form-input" id="pay-guarantee" value="12">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Fringe %</label>
                                        <input type="number" class="form-input" id="pay-fringe" value="23">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Call Time</label>
                                        <input type="time" class="form-input" id="pay-call" value="07:00">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Wrap Time</label>
                                        <input type="time" class="form-input" id="pay-wrap" value="19:00">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Meal 1 Out</label>
                                        <input type="time" class="form-input" id="pay-m1out" value="13:00">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Meal 1 In</label>
                                        <input type="time" class="form-input" id="pay-m1in" value="13:30">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Meal 2 Out</label>
                                        <input type="time" class="form-input" id="pay-m2out">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Meal 2 In</label>
                                        <input type="time" class="form-input" id="pay-m2in">
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer">
                                <button class="btn btn-primary" onclick="Payroll.calculate()">Calculate</button>
                                <button class="btn" onclick="Payroll.save()">Save Timecard</button>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">Calculation Result</div>
                            </div>
                            <div class="card-body">
                                <div class="result-box" id="pay-result">Enter timecard details and click Calculate to see breakdown.</div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Timecard History</div>
                            <button class="btn btn-sm" onclick="Payroll.exportCSV()">Export CSV</button>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Position</th>
                                        <th>Hours</th>
                                        <th>Gross</th>
                                        <th>Total</th>
                                        <th>Penalties</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="table-payroll"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="view-budget" class="view">
                    <div class="card mb-lg">
                        <div class="card-header">
                            <div class="card-title">Budget Overview</div>
                            <span class="text-muted font-mono">Click estimated values to edit</span>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Code</th>
                                        <th>Category</th>
                                        <th>Estimated</th>
                                        <th>Actual</th>
                                        <th>Variance</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="table-budget"></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card mb-lg">
                        <div class="card-header">
                            <div class="card-title">Issue Purchase Order</div>
                        </div>
                        <div class="card-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Budget Category</label>
                                    <select class="form-select" id="po-code">
                                        <option value="100">100 - Pre-Production</option>
                                        <option value="200">200 - Production Staff</option>
                                        <option value="300">300 - Talent</option>
                                        <option value="400">400 - Travel & Living</option>
                                        <option value="500">500 - Location</option>
                                        <option value="600">600 - Props & Wardrobe</option>
                                        <option value="700">700 - Studio & Set</option>
                                        <option value="800">800 - Equipment</option>
                                        <option value="900">900 - Film & Lab</option>
                                        <option value="1000">1000 - Post Production</option>
                                        <option value="1100">1100 - Insurance</option>
                                        <option value="1200">1200 - Contingency</option>
                                        <option value="1300">1300 - Other</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Vendor</label>
                                    <input type="text" class="form-input" id="po-vendor" placeholder="Vendor name">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Description</label>
                                    <input type="text" class="form-input" id="po-desc" placeholder="What is this for?">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Amount ($)</label>
                                    <input type="number" class="form-input" id="po-amount" placeholder="0.00">
                                </div>
                            </div>
                        </div>
                        <div class="card-footer">
                            <button class="btn btn-primary" onclick="Budget.issuePO()">Issue PO</button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Purchase Orders</div>
                            <button class="btn btn-sm" onclick="Budget.exportCSV()">Export CSV</button>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>PO #</th>
                                        <th>Vendor</th>
                                        <th>Category</th>
                                        <th>Description</th>
                                        <th>Amount</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="table-po"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="view-prod-pipeline" class="view">
                    <div class="mb-lg" style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <span class="tag tag-cyan">PRODUCTION CRM</span>
                            <span class="text-muted ml-md">Talent, Vendors, Sponsors, Investors</span>
                        </div>
                        <button class="btn btn-primary" onclick="ProdCRM.showLeadModal()">+ Add Contact</button>
                    </div>
                    <div class="kanban-wrapper" id="prod-kanban-board"></div>
                </div>

                <div id="view-prod-dialer" class="view">
                    <div class="mb-lg">
                        <span class="tag tag-cyan">PRODUCTION CRM</span>
                        <span class="text-muted ml-md">Dialer HUD</span>
                    </div>
                    <div class="dialer-grid">
                        <div class="dialer-main" id="prod-dialer-main">
                            <div class="dialer-waiting">
                                <div class="dialer-waiting-icon">📞</div>
                                <div>SELECT A CONTACT</div>
                                <div class="text-muted mt-md">Click a contact from the queue to begin</div>
                            </div>
                        </div>
                        <div class="dialer-queue-panel">
                            <div class="dialer-queue-header">Contact Queue</div>
                            <div class="dialer-queue" id="prod-dialer-queue"></div>
                        </div>
                    </div>
                </div>

                <div id="view-prod-intel" class="view">
                    <div class="mb-lg" style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <span class="tag tag-cyan">PRODUCTION CRM</span>
                            <span class="text-muted ml-md">Intel Dashboard</span>
                        </div>
                        <button class="btn btn-primary" onclick="ProdCRM.showIncomeModal()">+ Add Transaction</button>
                    </div>

                    <div class="grid grid-3 mb-lg">
                        <div class="card stat-card cyan">
                            <div class="stat-label">Pipeline Value</div>
                            <div class="stat-value" id="prod-intel-pipeline">$0</div>
                            <div class="stat-sub">Potential Revenue</div>
                        </div>
                        <div class="card stat-card emerald">
                            <div class="stat-label">Total Revenue</div>
                            <div class="stat-value" id="prod-intel-revenue">$0</div>
                            <div class="stat-sub">Confirmed</div>
                        </div>
                        <div class="card stat-card violet">
                            <div class="stat-label">Conversion Rate</div>
                            <div class="stat-value" id="prod-intel-conversion">0%</div>
                            <div class="stat-sub">Closed / Total</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Revenue Ledger</div>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Source</th>
                                        <th>Type</th>
                                        <th>Amount</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="prod-table-ledger"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="view-biz-pipeline" class="view">
                    <div class="mb-lg" style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <span class="business-crm-badge">BUSINESS CRM</span>
                            <span class="text-muted ml-md">VR, Cinema, General Video, Freelance</span>
                        </div>
                        <button class="btn btn-gold" onclick="BizCRM.showLeadModal()">+ Add Lead</button>
                    </div>
                    <div class="kanban-wrapper" id="biz-kanban-board"></div>
                </div>

                <div id="view-biz-dialer" class="view">
                    <div class="mb-lg">
                        <span class="business-crm-badge">BUSINESS CRM</span>
                        <span class="text-muted ml-md">Dialer HUD</span>
                    </div>
                    <div class="dialer-grid">
                        <div class="dialer-main" id="biz-dialer-main">
                            <div class="dialer-waiting">
                                <div class="dialer-waiting-icon">📞</div>
                                <div>SELECT A LEAD</div>
                                <div class="text-muted mt-md">Click a lead from the queue to begin</div>
                            </div>
                        </div>
                        <div class="dialer-queue-panel">
                            <div class="dialer-queue-header">Lead Queue</div>
                            <div class="dialer-queue" id="biz-dialer-queue"></div>
                        </div>
                    </div>
                </div>

                <div id="view-biz-intel" class="view">
                    <div class="mb-lg" style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <span class="business-crm-badge">BUSINESS CRM</span>
                            <span class="text-muted ml-md">Intel Dashboard</span>
                        </div>
                        <button class="btn btn-gold" onclick="BizCRM.showIncomeModal()">+ Add Transaction</button>
                    </div>

                    <div class="grid grid-3 mb-lg">
                        <div class="card stat-card gold">
                            <div class="stat-label">Pipeline Value</div>
                            <div class="stat-value" id="biz-intel-pipeline">$0</div>
                            <div class="stat-sub">Potential Revenue</div>
                        </div>
                        <div class="card stat-card emerald">
                            <div class="stat-label">Total Revenue</div>
                            <div class="stat-value" id="biz-intel-revenue">$0</div>
                            <div class="stat-sub">Confirmed</div>
                        </div>
                        <div class="card stat-card violet">
                            <div class="stat-label">Conversion Rate</div>
                            <div class="stat-value" id="biz-intel-conversion">0%</div>
                            <div class="stat-sub">Closed / Total</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Revenue Ledger</div>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Source</th>
                                        <th>Type</th>
                                        <th>Amount</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="biz-table-ledger"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <div class="modal-overlay" id="modal-prod-lead">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="prod-lead-modal-title">Add Contact</div>
                <button class="modal-close" onclick="ProdCRM.hideModals()">×</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="prod-lead-id">
                <div class="form-group">
                    <label class="form-label">Name</label>
                    <input type="text" class="form-input" id="prod-lead-name" placeholder="Contact name">
                </div>
                <div class="form-group">
                    <label class="form-label">Phone</label>
                    <input type="tel" class="form-input" id="prod-lead-phone" placeholder="(555) 123-4567">
                </div>
                <div class="form-group">
                    <label class="form-label">Type</label>
                    <select class="form-select" id="prod-lead-interest" onchange="ProdCRM.toggleCustomInterest()">
                        <option value="Talent">Talent</option>
                        <option value="Vendor">Vendor</option>
                        <option value="Sponsor">Sponsor</option>
                        <option value="Investor">Investor</option>
                        <option value="Custom">Custom...</option>
                    </select>
                </div>
                <div class="form-group hidden" id="prod-custom-interest-group">
                    <label class="form-label">Custom Type</label>
                    <input type="text" class="form-input" id="prod-lead-custom-interest" placeholder="Enter custom type">
                </div>
                <div class="form-group">
                    <label class="form-label">Value ($)</label>
                    <input type="number" class="form-input" id="prod-lead-value" placeholder="Potential value">
                </div>
                <div class="form-group">
                    <label class="form-label">Notes / Script</label>
                    <textarea class="form-textarea" id="prod-lead-notes" placeholder="Call script, notes, context..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="ProdCRM.hideModals()">Cancel</button>
                <button class="btn btn-primary" onclick="ProdCRM.saveLead()">Save</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-prod-income">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Add Transaction</div>
                <button class="modal-close" onclick="ProdCRM.hideModals()">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Source</label>
                    <input type="text" class="form-input" id="prod-income-source" placeholder="Client name, project...">
                </div>
                <div class="form-group">
                    <label class="form-label">Amount ($)</label>
                    <input type="number" class="form-input" id="prod-income-amount" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label class="form-label">Date</label>
                    <input type="date" class="form-input" id="prod-income-date">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="ProdCRM.hideModals()">Cancel</button>
                <button class="btn btn-primary" onclick="ProdCRM.saveIncome()">Save</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-biz-lead">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="biz-lead-modal-title">Add Lead</div>
                <button class="modal-close" onclick="BizCRM.hideModals()">×</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="biz-lead-id">
                <div class="form-group">
                    <label class="form-label">Name</label>
                    <input type="text" class="form-input" id="biz-lead-name" placeholder="Lead name">
                </div>
                <div class="form-group">
                    <label class="form-label">Phone</label>
                    <input type="tel" class="form-input" id="biz-lead-phone" placeholder="(555) 123-4567">
                </div>
                <div class="form-group">
                    <label class="form-label">Interest</label>
                    <select class="form-select" id="biz-lead-interest" onchange="BizCRM.toggleCustomInterest()">
                        <option value="Cinema">Cinema</option>
                        <option value="VR">VR</option>
                        <option value="General Video">General Video</option>
                        <option value="Cyber">Cyber</option>
                        <option value="Custom">Custom...</option>
                    </select>
                </div>
                <div class="form-group hidden" id="biz-custom-interest-group">
                    <label class="form-label">Custom Interest</label>
                    <input type="text" class="form-input" id="biz-lead-custom-interest" placeholder="Enter custom interest">
                </div>
                <div class="form-group">
                    <label class="form-label">Value ($)</label>
                    <input type="number" class="form-input" id="biz-lead-value" placeholder="Potential value">
                </div>
                <div class="form-group">
                    <label class="form-label">Notes / Script</label>
                    <textarea class="form-textarea" id="biz-lead-notes" placeholder="Call script, notes, context..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="BizCRM.hideModals()">Cancel</button>
                <button class="btn btn-gold" onclick="BizCRM.saveLead()">Save</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-biz-income">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Add Transaction</div>
                <button class="modal-close" onclick="BizCRM.hideModals()">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Source</label>
                    <input type="text" class="form-input" id="biz-income-source" placeholder="Client name, project...">
                </div>
                <div class="form-group">
                    <label class="form-label">Amount ($)</label>
                    <input type="number" class="form-input" id="biz-income-amount" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label class="form-label">Date</label>
                    <input type="date" class="form-input" id="biz-income-date">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="BizCRM.hideModals()">Cancel</button>
                <button class="btn btn-gold" onclick="BizCRM.saveIncome()">Save</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-new-production">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">New Production</div>
                <button class="modal-close" onclick="Productions.hideModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Production Name</label>
                    <input type="text" class="form-input" id="new-production-name" placeholder="My New Production">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="Productions.hideModal()">Cancel</button>
                <button class="btn btn-primary" onclick="Productions.create()">Create</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-scene">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="scene-modal-title">Add Scene</div>
                <button class="modal-close" onclick="Schedule.hideModals()">×</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="scene-id">
                <div class="scene-form-grid">
                    <div class="form-group">
                        <label class="form-label">Scene #</label>
                        <input type="text" class="form-input" id="scene-number" placeholder="1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">INT/EXT</label>
                        <select class="form-select" id="scene-intext">
                            <option value="INT">INT</option>
                            <option value="EXT">EXT</option>
                            <option value="INT/EXT">INT/EXT</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Day/Night</label>
                        <select class="form-select" id="scene-daynight">
                            <option value="DAY">DAY</option>
                            <option value="NIGHT">NIGHT</option>
                            <option value="DAWN">DAWN</option>
                            <option value="DUSK">DUSK</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Page Count</label>
                        <input type="text" class="form-input" id="scene-pages" placeholder="1">
                    </div>
                    <div class="form-group scene-form-full">
                        <label class="form-label">Script Location</label>
                        <input type="text" class="form-input" id="scene-location" placeholder="WAREHOUSE - MAIN FLOOR">
                    </div>
                    <div class="form-group scene-form-full">
                        <label class="form-label">Shooting Location</label>
                        <input type="text" class="form-input" id="scene-shoot-location" placeholder="ABC Studios, Stage 5">
                    </div>
                    <div class="form-group scene-form-full">
                        <label class="form-label">Description</label>
                        <input type="text" class="form-input" id="scene-description" placeholder="Heroes plan the heist">
                    </div>
                    <div class="form-group scene-form-full">
                        <label class="form-label">Cast (comma-separated IDs or names)</label>
                        <input type="text" class="form-input" id="scene-cast" placeholder="1, 2, 5 or Hero, Villain">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="Schedule.hideModals()">Cancel</button>
                <button class="btn btn-primary" onclick="Schedule.saveScene()">Save</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-banner">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Add Banner</div>
                <button class="modal-close" onclick="Schedule.hideModals()">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Banner Type</label>
                    <select class="form-select" id="banner-type">
                        <option value="COMPANY MOVE">COMPANY MOVE</option>
                        <option value="MEAL BREAK">MEAL BREAK</option>
                        <option value="TRAVEL">TRAVEL</option>
                        <option value="CUSTOM">CUSTOM</option>
                    </select>
                </div>
                <div class="form-group" id="banner-custom-group" style="display: none;">
                    <label class="form-label">Custom Text</label>
                    <input type="text" class="form-input" id="banner-custom" placeholder="Enter custom banner text">
                </div>
                <div class="form-group">
                    <label class="form-label">Estimated Time (minutes)</label>
                    <input type="number" class="form-input" id="banner-time" placeholder="30">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="Schedule.hideModals()">Cancel</button>
                <button class="btn btn-primary" onclick="Schedule.saveBanner()">Add Banner</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-cast-info">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-header" style="background: linear-gradient(135deg, var(--neon-cyan), var(--neon-blue)); border-bottom: none;">
                <div class="modal-title" style="color: var(--void-pure); display: flex; align-items: center; gap: var(--space-sm);">
                    <span style="background: var(--void-pure); color: var(--neon-cyan); padding: 4px 10px; border-radius: 4px; font-family: var(--font-mono); font-size: 12px; font-weight: 700;" id="cast-info-id"></span>
                    <span id="cast-info-name"></span>
                </div>
                <button class="modal-close" onclick="Schedule.hideCastInfo()" style="background: rgba(0,0,0,0.2); border-color: rgba(0,0,0,0.3); color: white;">×</button>
            </div>
            <div class="modal-body">
                <div style="background: var(--surface-3); padding: var(--space-lg); border-radius: 8px; margin-bottom: var(--space-md);">
                    <div style="font-size: 11px; color: var(--text-50); text-transform: uppercase; letter-spacing: 1px; margin-bottom: var(--space-xs);">Character/Role</div>
                    <div style="font-size: 16px; color: var(--text-100); font-weight: 600;" id="cast-info-role"></div>
                </div>
                <div id="cast-info-scenes" style="background: var(--surface-3); padding: var(--space-lg); border-radius: 8px;">
                    <div style="font-size: 11px; color: var(--text-50); text-transform: uppercase; letter-spacing: 1px; margin-bottom: var(--space-sm);">Appears In</div>
                    <div id="cast-info-scene-list"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="Schedule.hideCastInfo()">Close</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-analysis">
        <div class="modal" style="max-width: 900px;">
            <div class="modal-header">
                <div class="modal-title">Schedule Analysis</div>
                <button class="modal-close" onclick="Schedule.hideModals()">×</button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <div id="analysis-content"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="Schedule.hideModals()">Close</button>
            </div>
        </div>
    </div>

    <script>

        /* ═══════════════════════════════════════════════════════════════════════
           CONSTANTS
           ═══════════════════════════════════════════════════════════════════════ */
        const CRM_STAGES = [
            { id: 'new', name: 'New' },
            { id: 'contacted', name: 'Contacted' },
            { id: 'pitched', name: 'Pitched' },
            { id: 'negotiating', name: 'Negotiating' },
            { id: 'done', name: 'Closed' }
        ];

        const BREAKDOWN_CATEGORIES = [
            { id: 'cast', name: 'Cast', icon: '🎭', label: 'Speaking roles', color: 'cat-cast' },
            { id: 'stunts', name: 'Stunts', icon: '🤸', label: 'Stunt performers', color: 'cat-stunts' },
            { id: 'extras', name: 'Extras', icon: '👥', label: 'Background', color: 'cat-extras' },
            { id: 'vfx', name: 'VFX', icon: '✨', label: 'Visual effects', color: 'cat-vfx' },
            { id: 'props', name: 'Props', icon: '🎪', label: 'Hand props', color: 'cat-props' },
            { id: 'vehicles', name: 'Vehicles', icon: '🚗', label: 'Picture vehicles', color: 'cat-vehicles' },
            { id: 'wardrobe', name: 'Wardrobe', icon: '👔', label: 'Costumes', color: 'cat-wardrobe' },
            { id: 'makeup', name: 'Makeup/Hair', icon: '💄', label: 'Special makeup', color: 'cat-makeup' },
            { id: 'sound', name: 'Sound', icon: '🔊', label: 'Special sound', color: 'cat-sound' },
            { id: 'special-equip', name: 'Special Equipment', icon: '🎬', label: 'Cranes, dollies', color: 'cat-special-equip' },
            { id: 'prod-notes', name: 'Production Notes', icon: '📝', label: 'General notes', color: 'cat-prod-notes' }
        ];

        const DEFAULT_BUDGET = {
            lines: [
                { code: '100', name: 'Pre-Production', est: 5000, act: 0 },
                { code: '200', name: 'Production Staff', est: 25000, act: 0 },
                { code: '300', name: 'Talent', est: 15000, act: 0 },
                { code: '400', name: 'Travel & Living', est: 8000, act: 0 },
                { code: '500', name: 'Location', est: 10000, act: 0 },
                { code: '600', name: 'Props & Wardrobe', est: 5000, act: 0 },
                { code: '700', name: 'Studio & Set', est: 12000, act: 0 },
                { code: '800', name: 'Equipment', est: 15000, act: 0 },
                { code: '900', name: 'Film & Lab', est: 3000, act: 0 },
                { code: '1000', name: 'Post Production', est: 20000, act: 0 },
                { code: '1100', name: 'Insurance', est: 5000, act: 0 },
                { code: '1200', name: 'Contingency', est: 10000, act: 0 },
                { code: '1300', name: 'Other', est: 2000, act: 0 }
            ],
            pos: []
        };

        /* ═══════════════════════════════════════════════════════════════════════
           SCRIPT PARSER MODULE
           ═══════════════════════════════════════════════════════════════════════ */
        const ScriptImporter = {
            parse(rawText) {
                const lines = rawText.split('\n');
                const scenes = [];
                let currentScene = null;
                
                // Regex to catch standard headers (INT./EXT.) and your specific format (*INT.)
                const headerRegex = /^[\s\d]*[\*\.]?(INT\.|EXT\.|INT\/EXT\.|I\/E)\s*(.+?)(?:\s+-\s+|\s+)(DAY|NIGHT|DAWN|DUSK)/i;
                
                lines.forEach(line => {
                    const cleanLine = line.trim();
                    const headerMatch = cleanLine.match(headerRegex);

                    if (headerMatch) {
                        // Save previous scene if exists
                        if (currentScene) scenes.push(currentScene);

                        // Start new scene
                        currentScene = {
                            type: 'scene',
                            scene: (scenes.length + 1).toString(), // Auto-number
                            intext: headerMatch[1].toUpperCase().replace('.',''),
                            location: headerMatch[2].trim().toUpperCase(),
                            daynight: headerMatch[3].toUpperCase(),
                            description: '',
                            pages: '1', // Default, logic can be added to count lines
                            cast: [],
                            elements: {} 
                        };
                        
                        // Initialize breakdown categories
                        BREAKDOWN_CATEGORIES.forEach(cat => currentScene.elements[cat.id] = []);
                    } else if (currentScene) {
                        // Heuristic for Character Names (All CAPS, centered-ish)
                        // Avoids (V.O.) and timestamps like (0:10)
                        if (/^[A-Z][A-Z\s\(\)]+$/.test(cleanLine) && !cleanLine.includes('INT.') && !cleanLine.includes('EXT.') && cleanLine.length < 30) {
                            const charName = cleanLine.split('(')[0].trim(); // Remove (V.O.)
                            if (charName.length > 0 && !currentScene.cast.includes(charName)) {
                                currentScene.cast.push(charName);
                                // Also add to Cast elements automatically
                                currentScene.elements['cast'].push(charName);
                            }
                        }
                        // Heuristic for Description (if not character or parenthetical)
                        else if (cleanLine.length > 0 && !/^\(.*\)$/.test(cleanLine)) {
                             if (!currentScene.description) currentScene.description = cleanLine;
                        }
                    }
                });
                if (currentScene) scenes.push(currentScene);
                return scenes;
            },

            run() {
                const text = prompt("Paste your script text here:");
                if (!text) return;

                const scenes = this.parse(text);
                if (scenes.length === 0) {
                    alert("No scenes detected. Ensure headers match format: INT. LOCATION - DAY");
                    return;
                }

                if (confirm(`Detected ${scenes.length} scenes. Import will overwrite current schedule/breakdowns. Proceed?`)) {
                    
                    // NEW: Collect all unique cast members and sync to database
                    const allCast = new Set();
                    scenes.forEach(s => s.cast.forEach(c => allCast.add(c)));
                    CastCrew.syncFromImport(Array.from(allCast));

                    // 1. Populate Breakdown Sheets
                    Core.data.breakdowns = scenes.map(s => ({
                        sheet: s.scene,
                        pages: '1',
                        date: new Date().toLocaleDateString(),
                        project: Core.currentProduction,
                        scene: s.scene,
                        intext: s.intext,
                        daynight: s.daynight,
                        location: s.location,
                        description: s.description,
                        elements: s.elements
                    }));

                    // 2. Populate Stripboard
                    Core.data.schedule.strips = scenes.map(s => ({
                        type: 'scene',
                        scene: s.scene,
                        intext: s.intext,
                        daynight: s.daynight,
                        location: s.location,
                        description: s.description,
                        // Now that cast is synced, we can try to use IDs, but sticking to names for display is safer initially
                        cast: s.cast.join(', '), 
                        pages: '1',
                        elements: s.elements
                    }));

                    Core.save();
                    Schedule.render();
                    Breakdown.currentIdx = 0;
                    Breakdown.render();
                    alert("Script imported successfully! Cast members have been added to the database.");
                }
            }
        };

        /* ═══════════════════════════════════════════════════════════════════════
           BREAKDOWN MODULE (Array-based)
           ═══════════════════════════════════════════════════════════════════════ */
        const Breakdown = {
            currentIdx: 0,

            render() {
                // Ensure array exists
                if (!Core.data.breakdowns) Core.data.breakdowns = [];
                
                // If empty, create default
                if (Core.data.breakdowns.length === 0) this.createNew();

                const bd = Core.data.breakdowns[this.currentIdx];
                
                // Render Navigation Header
                const container = document.getElementById('view-breakdown');
                let navHtml = `
                    <div class="card mb-lg" style="background: var(--surface-3); border-color: var(--neon-cyan);">
                        <div class="card-body" style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-md);">
                            <button class="btn btn-sm" onclick="Breakdown.prev()">◀ Prev Scene</button>
                            <div style="text-align: center;">
                                <div style="font-weight: bold; color: var(--neon-cyan);">SCENE ${bd.scene}</div>
                                <div style="font-size: 10px; color: var(--text-50);">Sheet ${this.currentIdx + 1} of ${Core.data.breakdowns.length}</div>
                            </div>
                            <button class="btn btn-sm" onclick="Breakdown.next()">Next Scene ▶</button>
                            <button class="btn btn-sm btn-primary" onclick="Breakdown.createNew()">+ New Sheet</button>
                            <button class="btn btn-sm" onclick="Breakdown.exportPDF()">📄 Export PDF</button>
                        </div>
                    </div>
                    <datalist id="cast-autocomplete">
                        ${CastCrew.getCastOptionsHTML()}
                    </datalist>
                `;

                // Update Form Values
                document.getElementById('bd-sheet').value = bd.sheet || '';
                document.getElementById('bd-pages').value = bd.pages || '';
                document.getElementById('bd-date').value = bd.date || '';
                document.getElementById('bd-project').value = bd.project || '';
                document.getElementById('bd-scene').value = bd.scene || '';
                document.getElementById('bd-intext').value = bd.intext || 'INT';
                document.getElementById('bd-daynight').value = bd.daynight || 'DAY';
                document.getElementById('bd-location').value = bd.location || '';
                document.getElementById('bd-description').value = bd.description || '';

                // Render Categories 
                const catContainer = document.getElementById('breakdown-categories');
                catContainer.innerHTML = BREAKDOWN_CATEGORIES.map(cat => {
                    // NEW: Add 'list' attribute ONLY if category is 'cast'
                    const listAttr = cat.id === 'cast' ? 'list="cast-autocomplete"' : '';
                    
                    return `
                    <div class="breakdown-category ${cat.color}">
                        <div class="breakdown-category-header">
                            <div class="breakdown-category-title">
                                <span class="breakdown-category-icon">${cat.icon}</span>
                                <span class="breakdown-category-name">${cat.name}</span>
                            </div>
                        </div>
                        <div class="breakdown-elements" id="bd-elements-${cat.id}">
                            ${(bd.elements[cat.id] || []).map((el, i) => `
                                <div class="breakdown-element">
                                    <span>${el}</span>
                                    <button class="breakdown-element-del" onclick="Breakdown.removeElement('${cat.id}', ${i})">×</button>
                                </div>
                            `).join('')}
                        </div>
                        <div class="breakdown-add">
                            <input type="text" class="breakdown-add-input" id="bd-input-${cat.id}" ${listAttr}
                                   onkeydown="if(event.key==='Enter')Breakdown.addElement('${cat.id}')">
                            <button class="breakdown-add-btn" onclick="Breakdown.addElement('${cat.id}')">+</button>
                        </div>
                    </div>
                `}).join('');

                // Inject navigation controls if not already there
                if (!document.getElementById('bd-nav-controls')) {
                    const header = document.querySelector('#view-breakdown .print-header');
                    const navDiv = document.createElement('div');
                    navDiv.id = 'bd-nav-controls';
                    navDiv.innerHTML = navHtml;
                    header.after(navDiv);
                } else {
                    document.getElementById('bd-nav-controls').innerHTML = navHtml;
                }
            },

            createNew() {
                const newSheet = Core.getDefaultBreakdown();
                newSheet.scene = (Core.data.breakdowns.length + 1).toString();
                Core.data.breakdowns.push(newSheet);
                this.currentIdx = Core.data.breakdowns.length - 1;
                this.render();
            },

            saveCurrentState() {
                const bd = Core.data.breakdowns[this.currentIdx];
                bd.sheet = document.getElementById('bd-sheet').value;
                bd.pages = document.getElementById('bd-pages').value;
                bd.scene = document.getElementById('bd-scene').value;
                bd.intext = document.getElementById('bd-intext').value;
                bd.daynight = document.getElementById('bd-daynight').value;
                bd.location = document.getElementById('bd-location').value;
                bd.description = document.getElementById('bd-description').value;
                Core.save();
            },

            next() {
                this.saveCurrentState();
                if (this.currentIdx < Core.data.breakdowns.length - 1) {
                    this.currentIdx++;
                    this.render();
                }
            },

            prev() {
                this.saveCurrentState();
                if (this.currentIdx > 0) {
                    this.currentIdx--;
                    this.render();
                }
            },

            addElement(catId) {
                const input = document.getElementById('bd-input-' + catId);
                const val = input.value.trim();
                if (!val) return;
                
                const bd = Core.data.breakdowns[this.currentIdx];
                if (!bd.elements[catId]) bd.elements[catId] = [];
                bd.elements[catId].push(val);
                
                Core.save();
                this.render(); 
                input.value = '';
                input.focus();
            },

            removeElement(catId, elIdx) {
                const bd = Core.data.breakdowns[this.currentIdx];
                bd.elements[catId].splice(elIdx, 1);
                Core.save();
                this.render();
            },

            exportPDF() {
                this.saveCurrentState();
                const bd = Core.data.breakdowns[this.currentIdx];
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Header Box
                doc.setLineWidth(0.5);
                doc.rect(10, 10, 190, 25);
                doc.setFontSize(16);
                doc.setFont("helvetica", "bold");
                doc.text("BREAKDOWN SHEET", 105, 18, {align: "center"});
                
                doc.setFontSize(10);
                doc.text(`SCENE: ${bd.scene}`, 15, 28);
                doc.text(`LOC: ${bd.location}`, 60, 28);
                doc.text(`${bd.intext} / ${bd.daynight}`, 150, 28);

                // Grid
                let y = 45;
                let col = 0;
                BREAKDOWN_CATEGORIES.forEach(cat => {
                    const x = col === 0 ? 10 : 105;
                    doc.rect(x, y, 95, 35);
                    doc.setFont("helvetica", "bold");
                    doc.text(cat.name.toUpperCase(), x+2, y+5);
                    
                    doc.setFont("helvetica", "normal");
                    const items = (bd.elements[cat.id] || []).join(', ');
                    const lines = doc.splitTextToSize(items, 90);
                    doc.text(lines, x+2, y+10);

                    if (col === 1) { col = 0; y += 35; } 
                    else { col = 1; }
                    
                    if (y > 250) { doc.addPage(); y = 20; }
                });

                doc.save(`Breakdown_Scene_${bd.scene}.pdf`);
            }
        };

        /* ═══════════════════════════════════════════════════════════════════════
           CORE MODULE
           ═══════════════════════════════════════════════════════════════════════ */
        const Core = {
            data: null,
            bizData: null, // Business CRM data (global, separate from productions)
            logs: [],
            currentProduction: null,

            init() {
                // Load Business CRM data (global)
                this.bizData = JSON.parse(localStorage.getItem('dc_alacrity_business_crm')) || {
                    leads: [],
                    ledger: []
                };

                // Load productions
                const productions = this.getProductions();
                if (productions.length === 0) {
                    this.createProduction('SIDEQUEST');
                }
                
                const lastProd = localStorage.getItem('dc_alacrity_last_production') || productions[0];
                this.loadProduction(lastProd);
                this.renderProductionDropdown();
                
                // Setup navigation
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const view = item.dataset.view;
                        if (view) this.navigate(view);
                    });
                });

                this.log('System initialized');
                this.renderAll();
            },

            getProductions() {
                return JSON.parse(localStorage.getItem('dc_alacrity_productions')) || [];
            },

            createProduction(name) {
                const productions = this.getProductions();
                if (!productions.includes(name)) {
                    productions.push(name);
                    localStorage.setItem('dc_alacrity_productions', JSON.stringify(productions));
                }
                // Initialize production data
                const defaultData = this.getDefaultData();
                localStorage.setItem('dc_alacrity_prod_' + name, JSON.stringify(defaultData));
                return name;
            },

            getDefaultData() {
                return {
                    days: [],
                    tech: [],
                    vault: [],
                    payroll: [],
                    budget: JSON.parse(JSON.stringify(DEFAULT_BUDGET)),
                    // UPDATED: Breakdowns array
                    breakdowns: [], 
                    // Legacy/Current schedule
                    schedule: { strips: [] }, 
                    crm: { leads: [], ledger: [] }
                };
            },

            getDefaultBreakdown() {
                const elements = {};
                BREAKDOWN_CATEGORIES.forEach(c => elements[c.id] = []);
                return {
                    elements,
                    sheet: '1',
                    pages: '1',
                    date: new Date().toLocaleDateString(),
                    project: 'SIDEQUEST',
                    company: 'Speedforce Productions',
                    scene: '1',
                    intext: 'INT',
                    daynight: 'DAY',
                    location: '',
                    description: ''
                };
            },

            loadProduction(name) {
                this.currentProduction = name;
                localStorage.setItem('dc_alacrity_last_production', name);
                const stored = localStorage.getItem('dc_alacrity_prod_' + name);
                this.data = stored ? JSON.parse(stored) : this.getDefaultData();
                
                // Ensure all data structures exist
                if (!this.data.crm) this.data.crm = { leads: [], ledger: [] };
                if (!this.data.breakdowns) this.data.breakdowns = [this.getDefaultBreakdown()];
                if (!this.data.schedule) this.data.schedule = { strips: [] };
                
                this.log(`Loaded production: ${name}`);
            },

            save() {
                if (this.currentProduction && this.data) {
                    localStorage.setItem('dc_alacrity_prod_' + this.currentProduction, JSON.stringify(this.data));
                }
            },

            saveBizData() {
                localStorage.setItem('dc_alacrity_business_crm', JSON.stringify(this.bizData));
            },

            renderProductionDropdown() {
                const select = document.getElementById('project-select');
                const productions = this.getProductions();
                select.innerHTML = productions.map(p => 
                    `<option value="${p}" ${p === this.currentProduction ? 'selected' : ''}>${p}</option>`
                ).join('');
            },

            navigate(viewId) {
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                
                const view = document.getElementById('view-' + viewId);
                if (view) view.classList.add('active');
                
                const navItem = document.querySelector(`.nav-item[data-view="${viewId}"]`);
                if (navItem) navItem.classList.add('active');

                // Update page title
                const titles = {
                    'dashboard': 'COMMAND CENTER',
                    'days': 'SHOOTING DAYS',
                    'schedule': 'SHOOTING SCHEDULE',
                    'tech': 'TECH INVENTORY',
                    'vault': 'THE VAULT',
                    'breakdown': 'SCRIPT BREAKDOWN',
                    'payroll': 'PAYROLL ENGINE',
                    'budget': 'BUDGET LEDGER',
                    'prod-pipeline': 'PRODUCTION CRM - PIPELINE',
                    'prod-dialer': 'PRODUCTION CRM - DIALER',
                    'prod-intel': 'PRODUCTION CRM - INTEL',
                    'biz-pipeline': 'BUSINESS CRM - PIPELINE',
                    'biz-dialer': 'BUSINESS CRM - DIALER',
                    'biz-intel': 'BUSINESS CRM - INTEL'
                };
                document.getElementById('page-title').textContent = titles[viewId] || viewId.toUpperCase();

                // Render view-specific content
                if (viewId === 'breakdown') Breakdown.render();
                if (viewId === 'castcrew') CastCrew.render();
                if (viewId === 'schedule') Schedule.render();
                if (viewId === 'prod-pipeline') ProdCRM.renderPipeline();
                if (viewId === 'prod-dialer') ProdCRM.renderDialer();
                if (viewId === 'prod-intel') ProdCRM.renderIntel();
                if (viewId === 'biz-pipeline') BizCRM.renderPipeline();
                if (viewId === 'biz-dialer') BizCRM.renderDialer();
                if (viewId === 'biz-intel') BizCRM.renderIntel();
            },

            log(msg) {
                const time = new Date().toLocaleTimeString();
                this.logs.unshift({ time, msg });
                if (this.logs.length > 50) this.logs.pop();
                this.renderLogs();
            },

            renderLogs() {
                const container = document.getElementById('activity-log');
                if (!container) return;
                container.innerHTML = this.logs.map(l => `
                    <div class="log-entry">
                        <span class="log-time">${l.time}</span>
                        <span class="log-msg">${l.msg}</span>
                    </div>
                `).join('');
            },

            renderAll() {
                this.renderDashboard();
                Days.render();
                Tech.render();
                Vault.render();
                Payroll.render();
                Budget.render();
                ProdCRM.renderPipeline();
                ProdCRM.renderDialer();
                ProdCRM.renderIntel();
                BizCRM.renderPipeline();
                BizCRM.renderDialer();
                BizCRM.renderIntel();
                this.renderLogs();
            },

            renderDashboard() {
                // Stats
                document.getElementById('stat-days').textContent = this.data.days?.length || 0;
                document.getElementById('stat-vault').textContent = this.data.vault?.length || 0;
                document.getElementById('stat-tech').textContent = this.data.tech?.length || 0;

                // Budget calculations
                const totalEst = this.data.budget?.lines?.reduce((s, l) => s + l.est, 0) || 0;
                const totalAct = this.data.budget?.lines?.reduce((s, l) => s + l.act, 0) || 0;
                const remaining = totalEst - totalAct;
                const overBudgetLines = this.data.budget?.lines?.filter(l => l.act > l.est) || [];
                const overAmount = overBudgetLines.reduce((s, l) => s + (l.act - l.est), 0);

                document.getElementById('stat-budget').textContent = '$' + remaining.toLocaleString();
                document.getElementById('hot-budget').textContent = '$' + totalEst.toLocaleString();
                document.getElementById('hot-spent').textContent = '$' + totalAct.toLocaleString();

                // Payroll total
                const payrollTotal = this.data.payroll?.reduce((s, p) => s + (p.total || 0), 0) || 0;
                document.getElementById('hot-payroll').textContent = '$' + payrollTotal.toLocaleString();

                // Production CRM pipeline
                const prodPipeline = (this.data.crm?.leads || []).filter(l => l.status !== 'done').reduce((s, l) => s + Number(l.value || 0), 0);
                document.getElementById('stat-prod-pipeline').textContent = '$' + prodPipeline.toLocaleString();

                // Business CRM stats for dashboard
                const bizPipeline = (this.bizData?.leads || []).filter(l => l.status !== 'done').reduce((s, l) => s + Number(l.value || 0), 0);
                const bizRevenue = (this.bizData?.ledger || []).filter(l => l.type === 'income').reduce((s, l) => s + l.amount, 0);
                const bizLeadsCount = (this.bizData?.leads || []).filter(l => l.status !== 'done').length;
                document.getElementById('biz-pipeline-value').textContent = '$' + bizPipeline.toLocaleString();
                document.getElementById('biz-revenue-value').textContent = '$' + bizRevenue.toLocaleString();
                document.getElementById('biz-leads-count').textContent = bizLeadsCount;

                // Over budget handling
                const statusPill = document.getElementById('budget-status');
                const statusText = document.getElementById('budget-status-text');
                const overCard = document.getElementById('over-budget-card');
                const hotCostCard = document.getElementById('hot-cost-card');
                const hotCostBadge = document.getElementById('hot-cost-badge');

                if (overBudgetLines.length > 0) {
                    statusPill.classList.add('warning');
                    statusText.textContent = 'OVER BUDGET';
                    overCard.style.display = 'block';
                    document.getElementById('stat-over').textContent = '$' + overAmount.toLocaleString();
                    hotCostCard.style.boxShadow = 'var(--shadow-glow-rose)';
                    hotCostCard.style.borderColor = 'var(--neon-rose)';
                    hotCostBadge.innerHTML = '<span class="over-budget-badge">⚠ OVER</span>';
                } else {
                    statusPill.classList.remove('warning');
                    statusText.textContent = 'ON BUDGET';
                    overCard.style.display = 'none';
                    hotCostCard.style.boxShadow = '';
                    hotCostCard.style.borderColor = '';
                    hotCostBadge.innerHTML = '';
                }
            },

            download(content, filename) {
                const blob = new Blob([content], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
            }
        };

        /* ═══════════════════════════════════════════════════════════════════════
           PRODUCTIONS MODULE
           ═══════════════════════════════════════════════════════════════════════ */
        const Productions = {
            load() {
                const select = document.getElementById('project-select');
                Core.loadProduction(select.value);
                Core.renderAll();
            },
            showNew() {
                document.getElementById('modal-new-production').classList.add('active');
                document.getElementById('new-production-name').value = '';
                document.getElementById('new-production-name').focus();
            },
            hideModal() {
                document.getElementById('modal-new-production').classList.remove('active');
            },
            create() {
                const name = document.getElementById('new-production-name').value.trim();
                if (!name) { alert('Please enter a production name'); return; }
                const productions = Core.getProductions();
                if (productions.includes(name)) { alert('Production already exists'); return; }
                Core.createProduction(name);
                Core.loadProduction(name);
                Core.renderProductionDropdown();
                Core.renderAll();
                this.hideModal();
                Core.log(`Created production: ${name}`);
            },
            rename() {
                const newName = prompt('Enter new name:', Core.currentProduction);
                if (!newName || newName === Core.currentProduction) return;
                const productions = Core.getProductions();
                if (productions.includes(newName)) { alert('Production already exists'); return; }
                
                // Copy data to new name
                const data = localStorage.getItem('dc_alacrity_prod_' + Core.currentProduction);
                localStorage.setItem('dc_alacrity_prod_' + newName, data);
                localStorage.removeItem('dc_alacrity_prod_' + Core.currentProduction);
                
                // Update productions list
                const idx = productions.indexOf(Core.currentProduction);
                productions[idx] = newName;
                localStorage.setItem('dc_alacrity_productions', JSON.stringify(productions));
                
                Core.currentProduction = newName;
                Core.renderProductionDropdown();
                Core.log(`Renamed production to: ${newName}`);
            },
            delete() {
                const productions = Core.getProductions();
                if (productions.length <= 1) { alert('Cannot delete the only production'); return; }
                if (!confirm(`Delete "${Core.currentProduction}"? This cannot be undone.`)) return;
                
                localStorage.removeItem('dc_alacrity_prod_' + Core.currentProduction);
                const idx = productions.indexOf(Core.currentProduction);
                productions.splice(idx, 1);
                localStorage.setItem('dc_alacrity_productions', JSON.stringify(productions));
                
                Core.loadProduction(productions[0]);
                Core.renderProductionDropdown();
                Core.renderAll();
                Core.log('Production deleted');
            }
        };

        /* ═══════════════════════════════════════════════════════════════════════
           DAYS MODULE
           ═══════════════════════════════════════════════════════════════════════ */
        const Days = {
            add() {
                const date = document.getElementById('day-date').value;
                const call = document.getElementById('day-call').value;
                const wrap = document.getElementById('day-wrap').value;
                const location = document.getElementById('day-location').value;
                const notes = document.getElementById('day-notes').value;
                if (!date) { alert('Date is required'); return; }
                Core.data.days.unshift({ id: Date.now(), date, call, wrap, location, notes });
                Core.save();
                Core.log(`Shoot day added: ${date}`);
                this.render();
                Core.renderDashboard();
                document.getElementById('day-date').value = '';
                document.getElementById('day-location').value = '';
                document.getElementById('day-notes').value = '';
            },
            delete(id) {
                if (confirm('Delete this shoot day?')) {
                    Core.data.days = Core.data.days.filter(d => d.id !== id);
                    Core.save();
                    this.render();
                    Core.renderDashboard();
                    Core.log('Shoot day deleted');
                }
            },
            render() {
                const tbody = document.getElementById('table-days');
                if (!Core.data.days?.length) {
                    tbody.innerHTML = '<tr><td colspan="6" class="table-empty">No shoot days scheduled</td></tr>';
                    return;
                }
                tbody.innerHTML = Core.data.days.map(d => `
                    <tr>
                        <td class="font-mono font-bold">${d.date}</td>
                        <td class="font-mono">${d.call || '-'}</td>
                        <td class="font-mono">${d.wrap || '-'}</td>
                        <td>${d.location || '-'}</td>
                        <td class="text-muted">${d.notes || '-'}</td>
                        <td><button class="delete-btn" onclick="Days.delete(${d.id})">×</button></td>
                    </tr>
                `).join('');
            },
            exportCSV() {
                let csv = 'Date,Call,Wrap,Location,Notes\n';
                Core.data.days.forEach(d => csv += `"${d.date}","${d.call}","${d.wrap}","${d.location}","${d.notes}"\n`);
                Core.download(csv, 'shoot_days.csv');
                Core.log('Shoot days exported');
            }
        };

        /* ═══════════════════════════════════════════════════════════════════════
           TECH MODULE
           ═══════════════════════════════════════════════════════════════════════ */
        const Tech = {
            add() {
                const name = document.getElementById('tech-name').value;
                const category = document.getElementById('tech-category').value;
                const serial = document.getElementById('tech-serial').value;
                const owner = document.getElementById('tech-owner').value;
                if (!name) { alert('Item name is required'); return; }
                Core.data.tech.unshift({ id: Date.now(), name, category, serial, owner, status: 'Available' });
                Core.save();
                Core.log(`Equipment added: ${name}`);
                this.render();
                Core.renderDashboard();
                document.getElementById('tech-name').value = '';
                document.getElementById('tech-serial').value = '';
            },
            delete(id) {
                if (confirm('Delete this equipment?')) {
                    Core.data.tech = Core.data.tech.filter(t => t.id !== id);
                    Core.save();
                    this.render();
                    Core.renderDashboard();
                    Core.log('Equipment deleted');
                }
            },
            render() {
                const tbody = document.getElementById('table-tech');
                if (!Core.data.tech?.length) {
                    tbody.innerHTML = '<tr><td colspan="6" class="table-empty">No equipment logged</td></tr>';
                    return;
                }
                tbody.innerHTML = Core.data.tech.map(t => `
                    <tr>
                        <td class="font-bold">${t.name}</td>
                        <td><span class="tag tag-cyan">${t.category}</span></td>
                        <td class="font-mono">${t.serial || '-'}</td>
                        <td>${t.owner}</td>
                        <td><span class="tag tag-emerald">${t.status}</span></td>
                        <td><button class="delete-btn" onclick="Tech.delete(${t.id})">×</button></td>
                    </tr>
                `).join('');
            },
            exportCSV() {
                let csv = 'Name,Category,Serial,Owner,Status\n';
                Core.data.tech.forEach(t => csv += `"${t.name}","${t.category}","${t.serial}","${t.owner}","${t.status}"\n`);
                Core.download(csv, 'tech_inventory.csv');
                Core.log('Tech inventory exported');
            }
        };

        /* ═══════════════════════════════════════════════════════════════════════
           VAULT MODULE
           ═══════════════════════════════════════════════════════════════════════ */
        const Vault = {
            add() {
                const filename = document.getElementById('vault-filename').value;
                const scene = document.getElementById('vault-scene').value;
                const camera = document.getElementById('vault-camera').value;
                const storage = document.getElementById('vault-storage').value;
                const notes = document.getElementById('vault-notes').value;
                if (!filename) { alert('Filename is required'); return; }
                Core.data.vault.unshift({ id: Date.now(), filename, scene, camera, storage, notes });
                Core.save();
                Core.log(`Asset logged: ${filename}`);
                this.render();
                Core.renderDashboard();
                document.getElementById('vault-filename').value = '';
                document.getElementById('vault-scene').value = '';
                document.getElementById('vault-camera').value = '';
                document.getElementById('vault-storage').value = '';
                document.getElementById('vault-notes').value = '';
            },
            delete(id) {
                if (confirm('Delete this asset?')) {
                    Core.data.vault = Core.data.vault.filter(v => v.id !== id);
                    Core.save();
                    this.render();
                    Core.renderDashboard();
                    Core.log('Asset deleted');
                }
            },
            render() {
                const tbody = document.getElementById('table-vault');
                if (!Core.data.vault?.length) {
                    tbody.innerHTML = '<tr><td colspan="6" class="table-empty">No assets logged</td></tr>';
                    return;
                }
                tbody.innerHTML = Core.data.vault.map(v => `
                    <tr>
                        <td class="font-mono font-bold">${v.filename}</td>
                        <td>${v.scene || '-'}</td>
                        <td>${v.camera || '-'}</td>
                        <td><span class="tag tag-violet">${v.storage || '-'}</span></td>
                        <td class="text-muted">${v.notes || '-'}</td>
                        <td><button class="delete-btn" onclick="Vault.delete(${v.id})">×</button></td>
                    </tr>
                `).join('');
            },
            exportCSV() {
                let csv = 'Filename,Scene,Camera,Storage,Notes\n';
                Core.data.vault.forEach(v => csv += `"${v.filename}","${v.scene}","${v.camera}","${v.storage}","${v.notes}"\n`);
                Core.download(csv, 'vault_assets.csv');
                Core.log('Vault assets exported');
            }
        };

        /* ═══════════════════════════════════════════════════════════════════════
           PAYROLL MODULE
           ═══════════════════════════════════════════════════════════════════════ */
        const Payroll = {
            lastCalc: null,
            parseTime(str) {
                if (!str) return null;
                const [h, m] = str.split(':').map(Number);
                return h + m / 60;
            },
            calculate() {
                const name = document.getElementById('pay-name').value;
                const position = document.getElementById('pay-position').value;
                const dept = document.getElementById('pay-dept').value;
                const rate = parseFloat(document.getElementById('pay-rate').value);
                const guar = parseFloat(document.getElementById('pay-guarantee').value) || 12;
                const fringeRate = parseFloat(document.getElementById('pay-fringe').value) / 100;

                const callTime = this.parseTime(document.getElementById('pay-call').value);
                const wrapTime = this.parseTime(document.getElementById('pay-wrap').value);
                const m1out = this.parseTime(document.getElementById('pay-m1out').value);
                const m1in = this.parseTime(document.getElementById('pay-m1in').value);
                const m2out = this.parseTime(document.getElementById('pay-m2out').value);
                const m2in = this.parseTime(document.getElementById('pay-m2in').value);

                if (!name || !rate || callTime === null || wrapTime === null) {
                    alert('Name, rate, call time, and wrap time are required');
                    return;
                }

                let totalHours = wrapTime >= callTime ? wrapTime - callTime : (24 - callTime) + wrapTime;
                let mealTime = 0;
                if (m1out !== null && m1in !== null) mealTime += (m1in - m1out);
                if (m2out !== null && m2in !== null) mealTime += (m2in - m2out);
                totalHours -= mealTime;

                // Meal penalty detection (6-hour rule)
                let mealPenalties = 0;
                let mealPenaltyAmount = 0;
                const hoursToFirstMeal = m1out !== null ? (m1out - callTime) : totalHours;
                if (hoursToFirstMeal > 6) {
                    mealPenalties = Math.ceil(hoursToFirstMeal - 6);
                    mealPenaltyAmount = mealPenalties * 25;
                }
                if (m1in !== null && m2out !== null) {
                    const hoursToSecondMeal = m2out - m1in;
                    if (hoursToSecondMeal > 6) {
                        const extraPenalties = Math.ceil(hoursToSecondMeal - 6);
                        mealPenalties += extraPenalties;
                        mealPenaltyAmount += extraPenalties * 25;
                    }
                }

                // Calculate pay
                const hourlyRate = rate / guar;
                let straightHours = Math.min(totalHours, guar);
                let otHours = Math.min(Math.max(totalHours - guar, 0), 2);
                let goldenHours = Math.max(totalHours - guar - 2, 0);

                let gross = straightHours * hourlyRate;
                gross += otHours * hourlyRate * 1.5;
                gross += goldenHours * hourlyRate * 2.0;
                gross += mealPenaltyAmount;

                const fringes = gross * fringeRate;
                const total = gross + fringes;

                this.lastCalc = { name, position, dept, rate, guar, totalHours, straightHours, otHours, goldenHours, mealPenalties, mealPenaltyAmount, gross, fringes, total, fringeRate };

                const resultBox = document.getElementById('pay-result');
                resultBox.className = 'result-box success';
                resultBox.innerHTML = `
<strong>${name}</strong> - ${position} (${dept})
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Day Rate: $${rate.toFixed(2)} / ${guar}hr guarantee
Hourly: $${hourlyRate.toFixed(2)}/hr

HOURS BREAKDOWN
  Straight Time: ${straightHours.toFixed(2)} hrs × $${hourlyRate.toFixed(2)} = $${(straightHours * hourlyRate).toFixed(2)}
  Overtime (1.5×): ${otHours.toFixed(2)} hrs × $${(hourlyRate * 1.5).toFixed(2)} = $${(otHours * hourlyRate * 1.5).toFixed(2)}
  Golden (2.0×): ${goldenHours.toFixed(2)} hrs × $${(hourlyRate * 2).toFixed(2)} = $${(goldenHours * hourlyRate * 2).toFixed(2)}
  Meal Penalties: ${mealPenalties} × $25 = $${mealPenaltyAmount.toFixed(2)}
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
GROSS PAY: $${gross.toFixed(2)}
Fringes (${(fringeRate * 100).toFixed(1)}%): $${fringes.toFixed(2)}
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
<span style="color: var(--neon-emerald); font-size: 18px;">TOTAL: $${total.toFixed(2)}</span>`;
            },
            save() {
                if (!this.lastCalc) { alert('Calculate first'); return; }
                Core.data.payroll.unshift({ ...this.lastCalc, id: Date.now(), date: new Date().toISOString() });
                Core.save();
                Core.log(`Timecard saved: ${this.lastCalc.name} - $${this.lastCalc.total.toFixed(2)}`);
                this.render();
                Core.renderDashboard();
                this.lastCalc = null;
                document.getElementById('pay-result').className = 'result-box';
                document.getElementById('pay-result').textContent = 'Timecard saved! Enter next crew member.';
                document.getElementById('pay-name').value = '';
                document.getElementById('pay-position').value = '';
            },
            delete(id) {
                if (confirm('Delete this timecard?')) {
                    Core.data.payroll = Core.data.payroll.filter(p => p.id !== id);
                    Core.save();
                    this.render();
                    Core.renderDashboard();
                    Core.log('Timecard deleted');
                }
            },
            render() {
                const tbody = document.getElementById('table-payroll');
                if (!Core.data.payroll?.length) {
                    tbody.innerHTML = '<tr><td colspan="7" class="table-empty">No timecards processed</td></tr>';
                    return;
                }
                tbody.innerHTML = Core.data.payroll.map(p => `
                    <tr>
                        <td class="font-bold">${p.name}</td>
                        <td>${p.position}</td>
                        <td class="font-mono">${p.totalHours?.toFixed(1) || '-'}h</td>
                        <td class="font-mono text-gold">$${p.gross?.toFixed(2) || '-'}</td>
                        <td class="font-mono text-emerald font-bold">$${p.total?.toFixed(2) || '-'}</td>
                        <td>${p.mealPenalties > 0 ? `<span class="tag tag-rose">${p.mealPenalties} MP</span>` : '-'}</td>
                        <td><button class="delete-btn" onclick="Payroll.delete(${p.id})">×</button></td>
                    </tr>
                `).join('');
            },
            exportCSV() {
                let csv = 'Name,Position,Department,Rate,Hours,Gross,Fringes,Total,Meal Penalties,Date\n';
                Core.data.payroll.forEach(p => csv += `"${p.name}","${p.position}","${p.dept}",${p.rate},${p.totalHours?.toFixed(2)},${p.gross?.toFixed(2)},${p.fringes?.toFixed(2)},${p.total?.toFixed(2)},${p.mealPenalties},"${p.date}"\n`);
                Core.download(csv, 'payroll_export.csv');
                Core.log('Payroll exported');
            }
        };

        /* ═══════════════════════════════════════════════════════════════════════
           BUDGET MODULE
           ═══════════════════════════════════════════════════════════════════════ */
        const Budget = {
            render() {
                const tbody = document.getElementById('table-budget');
                if (!Core.data.budget?.lines) return;
                tbody.innerHTML = Core.data.budget.lines.map(l => {
                    const variance = l.est - l.act;
                    const isOver = l.act > l.est;
                    return `<tr class="${isOver ? 'over-budget' : ''}">
                        <td class="font-mono">${l.code}</td>
                        <td>${l.name}</td>
                        <td class="font-mono editable" onclick="Budget.editEstimate('${l.code}', this)">$${l.est.toLocaleString()}</td>
                        <td class="font-mono text-gold">$${l.act.toLocaleString()}</td>
                        <td class="font-mono ${variance < 0 ? 'text-rose' : 'text-emerald'}">${variance < 0 ? '-' : '+'}$${Math.abs(variance).toLocaleString()}</td>
                        <td>${isOver ? '<span class="over-budget-badge">⚠ OVER</span>' : '<span class="tag tag-emerald">OK</span>'}</td>
                    </tr>`;
                }).join('');
                this.renderPOs();
            },
            editEstimate(code, cell) {
                const line = Core.data.budget.lines.find(l => l.code === code);
                if (!line) return;
                const currentVal = line.est;
                const input = document.createElement('input');
                input.type = 'number';
                input.className = 'editable-input';
                input.value = currentVal;
                input.onblur = () => {
                    const newVal = parseFloat(input.value) || currentVal;
                    line.est = newVal;
                    Core.save();
                    this.render();
                    Core.renderDashboard();
                    Core.log(`Budget updated: ${line.name} → $${newVal.toLocaleString()}`);
                };
                input.onkeydown = (e) => {
                    if (e.key === 'Enter') input.blur();
                    if (e.key === 'Escape') { input.value = currentVal; input.blur(); }
                };
                cell.innerHTML = '';
                cell.appendChild(input);
                input.focus();
                input.select();
            },
            issuePO() {
                const code = document.getElementById('po-code').value;
                const vendor = document.getElementById('po-vendor').value;
                const desc = document.getElementById('po-desc').value;
                const amount = parseFloat(document.getElementById('po-amount').value);
                if (!vendor || !amount) { alert('Vendor and amount are required'); return; }
                const poNum = 'PO-' + (Core.data.budget.pos.length + 1).toString().padStart(4, '0');
                Core.data.budget.pos.unshift({ id: Date.now(), poNum, code, vendor, desc, amount, date: new Date().toISOString().split('T')[0] });
                const line = Core.data.budget.lines.find(l => l.code === code);
                if (line) line.act += amount;
                Core.save();
                Core.log(`PO issued: ${poNum} - $${amount.toFixed(2)} to ${vendor}`);
                this.render();
                Core.renderDashboard();
                document.getElementById('po-vendor').value = '';
                document.getElementById('po-desc').value = '';
                document.getElementById('po-amount').value = '';
            },
            deletePO(id) {
                const po = Core.data.budget.pos.find(p => p.id === id);
                if (!po) return;
                if (confirm(`Delete PO ${po.poNum}? This will reverse the budget actual.`)) {
                    const line = Core.data.budget.lines.find(l => l.code === po.code);
                    if (line) line.act = Math.max(0, line.act - po.amount);
                    Core.data.budget.pos = Core.data.budget.pos.filter(p => p.id !== id);
                    Core.save();
                    this.render();
                    Core.renderDashboard();
                    Core.log(`PO deleted: ${po.poNum}`);
                }
            },
            renderPOs() {
                const tbody = document.getElementById('table-po');
                if (!Core.data.budget?.pos?.length) {
                    tbody.innerHTML = '<tr><td colspan="7" class="table-empty">No purchase orders issued</td></tr>';
                    return;
                }
                tbody.innerHTML = Core.data.budget.pos.map(p => `
                    <tr>
                        <td class="font-mono">${p.date}</td>
                        <td><span class="tag tag-gold">${p.poNum}</span></td>
                        <td class="font-bold">${p.vendor}</td>
                        <td class="font-mono">${p.code}</td>
                        <td>${p.desc || '-'}</td>
                        <td class="font-mono text-gold">$${p.amount.toLocaleString(undefined, {minimumFractionDigits: 2})}</td>
                        <td><button class="delete-btn" onclick="Budget.deletePO(${p.id})">×</button></td>
                    </tr>
                `).join('');
            },
            exportCSV() {
                let csv = 'Date,PO Number,Vendor,Code,Description,Amount\n';
                Core.data.budget.pos.forEach(p => csv += `"${p.date}","${p.poNum}","${p.vendor}","${p.code}","${p.desc}",${p.amount}\n`);
                Core.download(csv, 'purchase_orders.csv');
                Core.log('POs exported');
            }
        };

        /* ═══════════════════════════════════════════════════════════════════════
           PRODUCTION CRM MODULE (Per-Production)
           ═══════════════════════════════════════════════════════════════════════ */
        const ProdCRM = {
            draggedLead: null,

            renderPipeline() {
                const board = document.getElementById('prod-kanban-board');
                board.innerHTML = CRM_STAGES.map(stage => {
                    const leads = (Core.data.crm?.leads || []).filter(l => l.status === stage.id);
                    return `
                        <div class="kanban-column" data-stage="${stage.id}">
                            <div class="kanban-column-header">
                                <span class="kanban-column-title">${stage.name}</span>
                                <span class="kanban-column-count">${leads.length}</span>
                            </div>
                            <div class="kanban-column-body" ondragover="ProdCRM.allowDrop(event)" ondrop="ProdCRM.drop(event, '${stage.id}')">
                                ${leads.map(l => this.renderLeadCard(l)).join('')}
                            </div>
                        </div>
                    `;
                }).join('');
            },

            renderLeadCard(lead) {
                const interestClass = {
                    'Talent': 'interest-talent',
                    'Vendor': 'interest-vendor',
                    'Sponsor': 'interest-sponsor',
                    'Investor': 'interest-investor'
                }[lead.interest] || 'interest-custom';
                return `
                    <div class="kanban-card ${interestClass}" draggable="true" ondragstart="ProdCRM.dragStart(event, ${lead.id})" data-id="${lead.id}">
                        <div class="kanban-card-actions">
                            <button class="kanban-card-btn call" onclick="ProdCRM.loadToDialer(${lead.id})" title="Call">📞</button>
                            <button class="kanban-card-btn" onclick="ProdCRM.editLead(${lead.id})" title="Edit">✎</button>
                            <button class="kanban-card-btn del" onclick="ProdCRM.deleteLead(${lead.id})" title="Delete">×</button>
                        </div>
                        <div class="kanban-card-name">${lead.name}</div>
                        <div class="kanban-card-phone">${lead.phone || 'No phone'}</div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span class="tag tag-${interestClass === 'interest-talent' ? 'pink' : interestClass === 'interest-vendor' ? 'cyan' : interestClass === 'interest-sponsor' ? 'gold' : interestClass === 'interest-investor' ? 'emerald' : 'violet'}">${lead.interest}</span>
                            <span class="kanban-card-value">$${Number(lead.value || 0).toLocaleString()}</span>
                        </div>
                    </div>
                `;
            },

            dragStart(e, id) {
                this.draggedLead = id;
                e.target.classList.add('dragging');
            },

            allowDrop(e) { e.preventDefault(); },

            drop(e, newStatus) {
                e.preventDefault();
                if (this.draggedLead) {
                    const lead = Core.data.crm.leads.find(l => l.id === this.draggedLead);
                    if (lead) {
                        lead.status = newStatus;
                        Core.save();
                        this.renderPipeline();
                        Core.log(`Contact "${lead.name}" moved to ${newStatus}`);
                    }
                }
                this.draggedLead = null;
            },

            showLeadModal(id = null) {
                document.getElementById('modal-prod-lead').classList.add('active');
                document.getElementById('prod-lead-modal-title').textContent = id ? 'Edit Contact' : 'Add Contact';
                document.getElementById('prod-lead-id').value = id || '';
                
                if (id) {
                    const lead = Core.data.crm.leads.find(l => l.id === id);
                    if (lead) {
                        document.getElementById('prod-lead-name').value = lead.name;
                        document.getElementById('prod-lead-phone').value = lead.phone || '';
                        const standardTypes = ['Talent', 'Vendor', 'Sponsor', 'Investor'];
                        if (standardTypes.includes(lead.interest)) {
                            document.getElementById('prod-lead-interest').value = lead.interest;
                            document.getElementById('prod-custom-interest-group').classList.add('hidden');
                        } else {
                            document.getElementById('prod-lead-interest').value = 'Custom';
                            document.getElementById('prod-lead-custom-interest').value = lead.interest;
                            document.getElementById('prod-custom-interest-group').classList.remove('hidden');
                        }
                        document.getElementById('prod-lead-value').value = lead.value || '';
                        document.getElementById('prod-lead-notes').value = lead.notes || '';
                    }
                } else {
                    document.getElementById('prod-lead-name').value = '';
                    document.getElementById('prod-lead-phone').value = '';
                    document.getElementById('prod-lead-interest').value = 'Talent';
                    document.getElementById('prod-lead-custom-interest').value = '';
                    document.getElementById('prod-custom-interest-group').classList.add('hidden');
                    document.getElementById('prod-lead-value').value = '';
                    document.getElementById('prod-lead-notes').value = '';
                }
            },

            editLead(id) { this.showLeadModal(id); },

            toggleCustomInterest() {
                const select = document.getElementById('prod-lead-interest');
                const customGroup = document.getElementById('prod-custom-interest-group');
                if (select.value === 'Custom') {
                    customGroup.classList.remove('hidden');
                } else {
                    customGroup.classList.add('hidden');
                }
            },

            saveLead() {
                const id = document.getElementById('prod-lead-id').value;
                const name = document.getElementById('prod-lead-name').value.trim();
                if (!name) { alert('Name is required'); return; }

                let interest = document.getElementById('prod-lead-interest').value;
                if (interest === 'Custom') {
                    interest = document.getElementById('prod-lead-custom-interest').value.trim() || 'Custom';
                }

                const leadData = {
                    name,
                    phone: document.getElementById('prod-lead-phone').value.trim(),
                    interest,
                    value: document.getElementById('prod-lead-value').value,
                    notes: document.getElementById('prod-lead-notes').value.trim()
                };

                if (id) {
                    const lead = Core.data.crm.leads.find(l => l.id === parseInt(id));
                    if (lead) Object.assign(lead, leadData);
                    Core.log(`Contact updated: ${name}`);
                } else {
                    Core.data.crm.leads.push({ id: Date.now(), status: 'new', ...leadData });
                    Core.log(`Contact added: ${name}`);
                }

                Core.save();
                this.hideModals();
                this.renderPipeline();
                this.renderDialer();
                this.renderIntel();
                Core.renderDashboard();
            },

            deleteLead(id) {
                if (confirm('Delete this contact?')) {
                    Core.data.crm.leads = Core.data.crm.leads.filter(l => l.id !== id);
                    Core.save();
                    this.renderPipeline();
                    this.renderDialer();
                    this.renderIntel();
                    Core.renderDashboard();
                    Core.log('Contact deleted');
                }
            },

            hideModals() {
                document.getElementById('modal-prod-lead').classList.remove('active');
                document.getElementById('modal-prod-income').classList.remove('active');
            },

            renderDialer() {
                const queue = document.getElementById('prod-dialer-queue');
                const leads = (Core.data.crm?.leads || []).filter(l => l.status !== 'done');
                if (!leads.length) {
                    queue.innerHTML = '<div class="text-muted">No contacts in queue</div>';
                    return;
                }
                queue.innerHTML = leads.map(l => `
                    <div class="dialer-queue-item" onclick="ProdCRM.loadToDialer(${l.id})" data-id="${l.id}">
                        <div class="font-bold">${l.name}</div>
                        <div class="font-mono text-muted" style="font-size: 12px;">${l.phone || 'No phone'}</div>
                        <div class="text-emerald font-mono" style="font-size: 13px;">$${Number(l.value || 0).toLocaleString()}</div>
                    </div>
                `).join('');
            },

            loadToDialer(id) {
                const lead = Core.data.crm.leads.find(l => l.id === id);
                if (!lead) return;
                document.querySelectorAll('#prod-dialer-queue .dialer-queue-item').forEach(el => el.classList.remove('active'));
                document.querySelector(`#prod-dialer-queue .dialer-queue-item[data-id="${id}"]`)?.classList.add('active');
                const main = document.getElementById('prod-dialer-main');
                main.innerHTML = `
                    <div class="dialer-name">${lead.name}</div>
                    <div class="dialer-phone">${lead.phone || 'NO PHONE'}</div>
                    <div class="dialer-script">${lead.notes || 'No script/notes available.\n\nAdd notes in the Pipeline view.'}</div>
                    <div class="dialer-controls">
                        <button class="dialer-btn skip" onclick="ProdCRM.skipLead(${id})" title="Skip">⏭</button>
                        <button class="dialer-btn call" onclick="ProdCRM.callLead(${id})" title="Call">📞</button>
                        <button class="dialer-btn done" onclick="ProdCRM.markDone(${id})" title="Mark Done">✓</button>
                    </div>
                `;
                Core.navigate('prod-dialer');
            },

            callLead(id) {
                const lead = Core.data.crm.leads.find(l => l.id === id);
                if (lead && lead.phone) {
                    window.open('tel:' + lead.phone.replace(/\D/g, ''));
                    Core.log(`Calling ${lead.name}`);
                }
            },

            skipLead(id) {
                const leads = Core.data.crm.leads.filter(l => l.status !== 'done');
                const idx = leads.findIndex(l => l.id === id);
                const nextLead = leads[(idx + 1) % leads.length];
                if (nextLead) this.loadToDialer(nextLead.id);
            },

            markDone(id) {
                const lead = Core.data.crm.leads.find(l => l.id === id);
                if (lead) {
                    lead.status = 'done';
                    Core.save();
                    Core.log(`Contact closed: ${lead.name}`);
                    this.renderPipeline();
                    this.renderDialer();
                    this.renderIntel();
                    Core.renderDashboard();
                    const remaining = Core.data.crm.leads.filter(l => l.status !== 'done');
                    if (remaining.length) {
                        this.loadToDialer(remaining[0].id);
                    } else {
                        document.getElementById('prod-dialer-main').innerHTML = `
                            <div class="dialer-waiting">
                                <div class="dialer-waiting-icon">🎉</div>
                                <div>ALL CONTACTS PROCESSED</div>
                                <div class="text-muted mt-md">Add more contacts in the Pipeline view</div>
                            </div>
                        `;
                    }
                }
            },

            showIncomeModal() {
                document.getElementById('modal-prod-income').classList.add('active');
                document.getElementById('prod-income-source').value = '';
                document.getElementById('prod-income-amount').value = '';
                document.getElementById('prod-income-date').value = new Date().toISOString().split('T')[0];
            },

            saveIncome() {
                const source = document.getElementById('prod-income-source').value.trim();
                const amount = parseFloat(document.getElementById('prod-income-amount').value);
                const date = document.getElementById('prod-income-date').value;
                if (!source || !amount) { alert('Source and amount required'); return; }
                Core.data.crm.ledger.unshift({ id: Date.now(), source, amount, date, type: 'income' });
                Core.save();
                this.hideModals();
                this.renderIntel();
                Core.log(`Income added: $${amount.toLocaleString()} from ${source}`);
            },

            deleteIncome(id) {
                if (confirm('Delete this transaction?')) {
                    Core.data.crm.ledger = Core.data.crm.ledger.filter(l => l.id !== id);
                    Core.save();
                    this.renderIntel();
                    Core.log('Transaction deleted');
                }
            },

            renderIntel() {
                const leads = Core.data.crm?.leads || [];
                const ledger = Core.data.crm?.ledger || [];
                
                const pipelineValue = leads.filter(l => l.status !== 'done').reduce((s, l) => s + Number(l.value || 0), 0);
                const totalRevenue = ledger.filter(l => l.type === 'income').reduce((s, l) => s + l.amount, 0);
                const totalLeads = leads.length;
                const closedLeads = leads.filter(l => l.status === 'done').length;
                const conversionRate = totalLeads > 0 ? ((closedLeads / totalLeads) * 100).toFixed(1) : 0;

                document.getElementById('prod-intel-pipeline').textContent = '$' + pipelineValue.toLocaleString();
                document.getElementById('prod-intel-revenue').textContent = '$' + totalRevenue.toLocaleString();
                document.getElementById('prod-intel-conversion').textContent = conversionRate + '%';

                const tbody = document.getElementById('prod-table-ledger');
                if (!ledger.length) {
                    tbody.innerHTML = '<tr><td colspan="5" class="table-empty">No transactions recorded</td></tr>';
                    return;
                }
                tbody.innerHTML = ledger.map(l => `
                    <tr>
                        <td class="font-mono">${l.date}</td>
                        <td class="font-bold">${l.source}</td>
                        <td><span class="tag tag-emerald">${l.type.toUpperCase()}</span></td>
                        <td class="font-mono text-emerald font-bold">$${l.amount.toLocaleString()}</td>
                        <td><button class="delete-btn" onclick="ProdCRM.deleteIncome(${l.id})">×</button></td>
                    </tr>
                `).join('');
            }
        };

        /* ═══════════════════════════════════════════════════════════════════════
           BUSINESS CRM MODULE (Global - Separate from Productions)
           ═══════════════════════════════════════════════════════════════════════ */
        const BizCRM = {
            draggedLead: null,

            renderPipeline() {
                const board = document.getElementById('biz-kanban-board');
                board.innerHTML = CRM_STAGES.map(stage => {
                    const leads = (Core.bizData?.leads || []).filter(l => l.status === stage.id);
                    return `
                        <div class="kanban-column" data-stage="${stage.id}">
                            <div class="kanban-column-header">
                                <span class="kanban-column-title">${stage.name}</span>
                                <span class="kanban-column-count">${leads.length}</span>
                            </div>
                            <div class="kanban-column-body" ondragover="BizCRM.allowDrop(event)" ondrop="BizCRM.drop(event, '${stage.id}')">
                                ${leads.map(l => this.renderLeadCard(l)).join('')}
                            </div>
                        </div>
                    `;
                }).join('');
            },

            renderLeadCard(lead) {
                const interestClass = {
                    'Cinema': 'interest-cinema',
                    'VR': 'interest-vr',
                    'General Video': 'interest-video',
                    'Cyber': 'interest-cyber'
                }[lead.interest] || 'interest-custom';
                return `
                    <div class="kanban-card ${interestClass}" draggable="true" ondragstart="BizCRM.dragStart(event, ${lead.id})" data-id="${lead.id}">
                        <div class="kanban-card-actions">
                            <button class="kanban-card-btn call" onclick="BizCRM.loadToDialer(${lead.id})" title="Call">📞</button>
                            <button class="kanban-card-btn" onclick="BizCRM.editLead(${lead.id})" title="Edit">✎</button>
                            <button class="kanban-card-btn del" onclick="BizCRM.deleteLead(${lead.id})" title="Delete">×</button>
                        </div>
                        <div class="kanban-card-name">${lead.name}</div>
                        <div class="kanban-card-phone">${lead.phone || 'No phone'}</div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span class="tag tag-${interestClass === 'interest-cinema' ? 'pink' : interestClass === 'interest-vr' ? 'cyan' : interestClass === 'interest-video' ? 'emerald' : interestClass === 'interest-cyber' ? 'violet' : 'gold'}">${lead.interest}</span>
                            <span class="kanban-card-value">$${Number(lead.value || 0).toLocaleString()}</span>
                        </div>
                    </div>
                `;
            },

            dragStart(e, id) {
                this.draggedLead = id;
                e.target.classList.add('dragging');
            },

            allowDrop(e) { e.preventDefault(); },

            drop(e, newStatus) {
                e.preventDefault();
                if (this.draggedLead) {
                    const lead = Core.bizData.leads.find(l => l.id === this.draggedLead);
                    if (lead) {
                        lead.status = newStatus;
                        Core.saveBizData();
                        this.renderPipeline();
                        Core.log(`Lead "${lead.name}" moved to ${newStatus}`);
                    }
                }
                this.draggedLead = null;
            },

            showLeadModal(id = null) {
                document.getElementById('modal-biz-lead').classList.add('active');
                document.getElementById('biz-lead-modal-title').textContent = id ? 'Edit Lead' : 'Add Lead';
                document.getElementById('biz-lead-id').value = id || '';
                
                if (id) {
                    const lead = Core.bizData.leads.find(l => l.id === id);
                    if (lead) {
                        document.getElementById('biz-lead-name').value = lead.name;
                        document.getElementById('biz-lead-phone').value = lead.phone || '';
                        const standardInterests = ['Cinema', 'VR', 'General Video', 'Cyber'];
                        if (standardInterests.includes(lead.interest)) {
                            document.getElementById('biz-lead-interest').value = lead.interest;
                            document.getElementById('biz-custom-interest-group').classList.add('hidden');
                        } else {
                            document.getElementById('biz-lead-interest').value = 'Custom';
                            document.getElementById('biz-lead-custom-interest').value = lead.interest;
                            document.getElementById('biz-custom-interest-group').classList.remove('hidden');
                        }
                        document.getElementById('biz-lead-value').value = lead.value || '';
                        document.getElementById('biz-lead-notes').value = lead.notes || '';
                    }
                } else {
                    document.getElementById('biz-lead-name').value = '';
                    document.getElementById('biz-lead-phone').value = '';
                    document.getElementById('biz-lead-interest').value = 'Cinema';
                    document.getElementById('biz-lead-custom-interest').value = '';
                    document.getElementById('biz-custom-interest-group').classList.add('hidden');
                    document.getElementById('biz-lead-value').value = '';
                    document.getElementById('biz-lead-notes').value = '';
                }
            },

            editLead(id) { this.showLeadModal(id); },

            toggleCustomInterest() {
                const select = document.getElementById('biz-lead-interest');
                const customGroup = document.getElementById('biz-custom-interest-group');
                if (select.value === 'Custom') {
                    customGroup.classList.remove('hidden');
                } else {
                    customGroup.classList.add('hidden');
                }
            },

            saveLead() {
                const id = document.getElementById('biz-lead-id').value;
                const name = document.getElementById('biz-lead-name').value.trim();
                if (!name) { alert('Name is required'); return; }

                let interest = document.getElementById('biz-lead-interest').value;
                if (interest === 'Custom') {
                    interest = document.getElementById('biz-lead-custom-interest').value.trim() || 'Custom';
                }

                const leadData = {
                    name,
                    phone: document.getElementById('biz-lead-phone').value.trim(),
                    interest,
                    value: document.getElementById('biz-lead-value').value,
                    notes: document.getElementById('biz-lead-notes').value.trim()
                };

                if (id) {
                    const lead = Core.bizData.leads.find(l => l.id === parseInt(id));
                    if (lead) Object.assign(lead, leadData);
                    Core.log(`Lead updated: ${name}`);
                } else {
                    Core.bizData.leads.push({ id: Date.now(), status: 'new', ...leadData });
                    Core.log(`Lead added: ${name}`);
                }

                Core.saveBizData();
                this.hideModals();
                this.renderPipeline();
                this.renderDialer();
                this.renderIntel();
                Core.renderDashboard();
            },

            deleteLead(id) {
                if (confirm('Delete this lead?')) {
                    Core.bizData.leads = Core.bizData.leads.filter(l => l.id !== id);
                    Core.saveBizData();
                    this.renderPipeline();
                    this.renderDialer();
                    this.renderIntel();
                    Core.renderDashboard();
                    Core.log('Lead deleted');
                }
            },

            hideModals() {
                document.getElementById('modal-biz-lead').classList.remove('active');
                document.getElementById('modal-biz-income').classList.remove('active');
            },

            renderDialer() {
                const queue = document.getElementById('biz-dialer-queue');
                const leads = (Core.bizData?.leads || []).filter(l => l.status !== 'done');
                if (!leads.length) {
                    queue.innerHTML = '<div class="text-muted">No leads in queue</div>';
                    return;
                }
                queue.innerHTML = leads.map(l => `
                    <div class="dialer-queue-item" onclick="BizCRM.loadToDialer(${l.id})" data-id="${l.id}">
                        <div class="font-bold">${l.name}</div>
                        <div class="font-mono text-muted" style="font-size: 12px;">${l.phone || 'No phone'}</div>
                        <div class="text-gold font-mono" style="font-size: 13px;">$${Number(l.value || 0).toLocaleString()}</div>
                    </div>
                `).join('');
            },

            loadToDialer(id) {
                const lead = Core.bizData.leads.find(l => l.id === id);
                if (!lead) return;
                document.querySelectorAll('#biz-dialer-queue .dialer-queue-item').forEach(el => el.classList.remove('active'));
                document.querySelector(`#biz-dialer-queue .dialer-queue-item[data-id="${id}"]`)?.classList.add('active');
                const main = document.getElementById('biz-dialer-main');
                main.innerHTML = `
                    <div class="dialer-name">${lead.name}</div>
                    <div class="dialer-phone">${lead.phone || 'NO PHONE'}</div>
                    <div class="dialer-script">${lead.notes || 'No script/notes available.\n\nAdd notes in the Pipeline view.'}</div>
                    <div class="dialer-controls">
                        <button class="dialer-btn skip" onclick="BizCRM.skipLead(${id})" title="Skip">⏭</button>
                        <button class="dialer-btn call" onclick="BizCRM.callLead(${id})" title="Call">📞</button>
                        <button class="dialer-btn done" onclick="BizCRM.markDone(${id})" title="Mark Done">✓</button>
                    </div>
                `;
                Core.navigate('biz-dialer');
            },

            callLead(id) {
                const lead = Core.bizData.leads.find(l => l.id === id);
                if (lead && lead.phone) {
                    window.open('tel:' + lead.phone.replace(/\D/g, ''));
                    Core.log(`Calling ${lead.name}`);
                }
            },

            skipLead(id) {
                const leads = Core.bizData.leads.filter(l => l.status !== 'done');
                const idx = leads.findIndex(l => l.id === id);
                const nextLead = leads[(idx + 1) % leads.length];
                if (nextLead) this.loadToDialer(nextLead.id);
            },

            markDone(id) {
                const lead = Core.bizData.leads.find(l => l.id === id);
                if (lead) {
                    lead.status = 'done';
                    Core.saveBizData();
                    Core.log(`Lead closed: ${lead.name}`);
                    this.renderPipeline();
                    this.renderDialer();
                    this.renderIntel();
                    Core.renderDashboard();
                    const remaining = Core.bizData.leads.filter(l => l.status !== 'done');
                    if (remaining.length) {
                        this.loadToDialer(remaining[0].id);
                    } else {
                        document.getElementById('biz-dialer-main').innerHTML = `
                            <div class="dialer-waiting">
                                <div class="dialer-waiting-icon">🎉</div>
                                <div>ALL LEADS PROCESSED</div>
                                <div class="text-muted mt-md">Add more leads in the Pipeline view</div>
                            </div>
                        `;
                    }
                }
            },

            showIncomeModal() {
                document.getElementById('modal-biz-income').classList.add('active');
                document.getElementById('biz-income-source').value = '';
                document.getElementById('biz-income-amount').value = '';
                document.getElementById('biz-income-date').value = new Date().toISOString().split('T')[0];
            },

            saveIncome() {
                const source = document.getElementById('biz-income-source').value.trim();
                const amount = parseFloat(document.getElementById('biz-income-amount').value);
                const date = document.getElementById('biz-income-date').value;
                if (!source || !amount) { alert('Source and amount required'); return; }
                Core.bizData.ledger.unshift({ id: Date.now(), source, amount, date, type: 'income' });
                Core.saveBizData();
                this.hideModals();
                this.renderIntel();
                Core.renderDashboard();
                Core.log(`Income added: $${amount.toLocaleString()} from ${source}`);
            },

            deleteIncome(id) {
                if (confirm('Delete this transaction?')) {
                    Core.bizData.ledger = Core.bizData.ledger.filter(l => l.id !== id);
                    Core.saveBizData();
                    this.renderIntel();
                    Core.renderDashboard();
                    Core.log('Transaction deleted');
                }
            },

            renderIntel() {
                const leads = Core.bizData?.leads || [];
                const ledger = Core.bizData?.ledger || [];
                
                const pipelineValue = leads.filter(l => l.status !== 'done').reduce((s, l) => s + Number(l.value || 0), 0);
                const totalRevenue = ledger.filter(l => l.type === 'income').reduce((s, l) => s + l.amount, 0);
                const totalLeads = leads.length;
                const closedLeads = leads.filter(l => l.status === 'done').length;
                const conversionRate = totalLeads > 0 ? ((closedLeads / totalLeads) * 100).toFixed(1) : 0;

                document.getElementById('biz-intel-pipeline').textContent = '$' + pipelineValue.toLocaleString();
                document.getElementById('biz-intel-revenue').textContent = '$' + totalRevenue.toLocaleString();
                document.getElementById('biz-intel-conversion').textContent = conversionRate + '%';

                const tbody = document.getElementById('biz-table-ledger');
                if (!ledger.length) {
                    tbody.innerHTML = '<tr><td colspan="5" class="table-empty">No transactions recorded</td></tr>';
                    return;
                }
                tbody.innerHTML = ledger.map(l => `
                    <tr>
                        <td class="font-mono">${l.date}</td>
                        <td class="font-bold">${l.source}</td>
                        <td><span class="tag tag-emerald">${l.type.toUpperCase()}</span></td>
                        <td class="font-mono text-emerald font-bold">$${l.amount.toLocaleString()}</td>
                        <td><button class="delete-btn" onclick="BizCRM.deleteIncome(${l.id})">×</button></td>
                    </tr>
                `).join('');
            }
        };

        /* ═══════════════════════════════════════════════════════════════════════
           CAST & CREW MODULE
           ═══════════════════════════════════════════════════════════════════════ */
        const CastCrew = {
            render() {
                if (!Core.data.cast) Core.data.cast = {};
                if (!Core.data.crew) Core.data.crew = {};
                this.renderList('cast');
                this.renderList('crew');
            },
            
            renderList(type) {
                const list = document.getElementById(`${type}-list`);
                const members = Core.data[type] || {};
                const entries = Object.entries(members).sort((a, b) => {
                    const numA = parseInt(a[1].id.replace(/\D/g, ''));
                    const numB = parseInt(b[1].id.replace(/\D/g, ''));
                    return numA - numB;
                });
                
                if (entries.length === 0) {
                    list.innerHTML = `<p class="text-muted">No ${type} members yet</p>`;
                    return;
                }
                
                list.innerHTML = entries.map(([key, member]) => `
                    <div style="background: var(--surface-3); padding: var(--space-md); border-radius: 6px; margin-bottom: var(--space-sm); display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: var(--space-sm); margin-bottom: var(--space-xs);">
                                <span style="background: var(--neon-cyan); color: var(--void-pure); padding: 2px 8px; border-radius: 4px; font-family: var(--font-mono); font-size: 10px; font-weight: 700;">${member.id}</span>
                                <span style="font-weight: 700; color: var(--text-100);">${member.name}</span>
                            </div>
                            <div style="font-size: 12px; color: var(--text-50);">${member.role || member.position || 'No role specified'}</div>
                        </div>
                        <button class="delete-btn" onclick="CastCrew.remove('${type}', '${key}')">×</button>
                    </div>
                `).join('');
            },

            // NEW: Bulk import characters from script
            syncFromImport(names) {
                if (!Core.data.cast) Core.data.cast = {};
                let addedCount = 0;
                
                // Normalize existing names to lowercase for comparison
                const existingNames = Object.values(Core.data.cast).map(m => m.name.toLowerCase());
                
                // Calculate next ID
                const existingIds = Object.values(Core.data.cast).map(m => {
                    const num = parseInt(m.id.replace(/\D/g, ''));
                    return isNaN(num) ? 0 : num;
                });
                let nextNum = existingIds.length > 0 ? Math.max(...existingIds) + 1 : 1;

                names.forEach(name => {
                    const cleanName = name.trim();
                    if (cleanName && !existingNames.includes(cleanName.toLowerCase())) {
                        const id = 'C' + nextNum.toString().padStart(3, '0');
                        const key = Date.now().toString() + Math.random().toString().slice(2, 5);
                        
                        Core.data.cast[key] = {
                            id,
                            name: cleanName,
                            role: 'Script Character' 
                        };
                        existingNames.push(cleanName.toLowerCase());
                        nextNum++;
                        addedCount++;
                    }
                });
                
                if (addedCount > 0) {
                    Core.save();
                    this.render();
                    Core.log(`Imported ${addedCount} new cast members from script`);
                }
            },

            // NEW: Generate options for datalist
            getCastOptionsHTML() {
                if (!Core.data.cast) return '';
                return Object.values(Core.data.cast)
                    .sort((a, b) => a.name.localeCompare(b.name))
                    .map(c => `<option value="${c.name}">${c.id}</option>`)
                    .join('');
            },
            
            addMember(type) {
                const name = prompt(`Enter ${type} member name:`);
                if (!name) return;
                
                const existing = Object.values(Core.data[type] || {});
                if (existing.some(m => m.name.toLowerCase() === name.toLowerCase())) {
                    alert(`A ${type} member named "${name}" already exists!`);
                    return;
                }
                
                const roleLabel = type === 'cast' ? 'Enter character/role:' : 'Enter position/department:';
                const role = prompt(roleLabel);
                
                const existingIds = Object.values(Core.data[type] || {}).map(m => {
                    const num = parseInt(m.id.replace(/\D/g, ''));
                    return isNaN(num) ? 0 : num;
                });
                const nextNum = existingIds.length > 0 ? Math.max(...existingIds) + 1 : 1;
                const id = 'C' + nextNum.toString().padStart(3, '0');
                
                const key = Date.now().toString();
                if (!Core.data[type]) Core.data[type] = {};
                
                Core.data[type][key] = {
                    id,
                    name,
                    [type === 'cast' ? 'role' : 'position']: role
                };
                
                Core.save();
                this.render();
                Core.log(`Added ${type}: ${name} (${id})`);
            },
            
            remove(type, key) {
                if (confirm(`Remove this ${type} member?`)) {
                    delete Core.data[type][key];
                    Core.save();
                    this.render();
                }
            },
            
            findByName(name) {
                const cast = Core.data.cast || {};
                for (let [key, member] of Object.entries(cast)) {
                    if (member.name.toLowerCase() === name.toLowerCase()) {
                        return member;
                    }
                }
                return null;
            },
            
            findById(id) {
                const cast = Core.data.cast || {};
                for (let [key, member] of Object.entries(cast)) {
                    if (member.id === id) {
                        return member;
                    }
                }
                return null;
            },
            
            getCastList() {
                return Object.values(Core.data.cast || {}).sort((a, b) => {
                    const numA = parseInt(a.id.replace(/\D/g, ''));
                    const numB = parseInt(b.id.replace(/\D/g, ''));
                    return numA - numB;
                });
            },
            
            parseCastString(castStr) {
                if (!castStr) return [];
                const parts = castStr.split(',').map(s => s.trim()).filter(s => s);
                const result = [];
                
                for (let part of parts) {
                    if (/^C\d{3}$/.test(part)) {
                        const member = this.findById(part);
                        if (member) {
                            result.push({ id: member.id, name: member.name });
                        }
                    } else {
                        const member = this.findByName(part);
                        if (member) {
                            result.push({ id: member.id, name: member.name });
                        } else {
                            // Create if not exists (legacy behavior fallback)
                            this.syncFromImport([part]); 
                            const newMember = this.findByName(part);
                            if (newMember) result.push({ id: newMember.id, name: newMember.name });
                        }
                    }
                }
                return result;
            },
            
            formatCastForDisplay(castArray) {
                return castArray.map(c => `${c.id}`).join(', ');
            }
        };


        const Schedule = {
            draggedIndex: null,

            render() {
                const container = document.getElementById('stripboard-container');
                const strips = Core.data.schedule?.strips || [];
                
                if (!strips.length) {
                    container.innerHTML = '<div style="text-align: center; color: var(--text-50); padding: var(--space-2xl);">No scenes added yet. Click "+ Add Scene" or import from Script Breakdown.</div>';
                    this.updateStats();
                    return;
                }

                container.innerHTML = strips.map((strip, index) => {
                    if (strip.type === 'daybreak') {
                        return `
                            <div class="daybreak" draggable="true" ondragstart="Schedule.dragStart(event, ${index})" ondragover="Schedule.allowDrop(event)" ondrop="Schedule.drop(event, ${index})">
                                <div class="daybreak-label">DAY ${strip.dayNumber} - ${strip.date || 'TBD'}</div>
                                <div class="daybreak-info">
                                    <span class="daybreak-pages">${strip.totalPages || '0'} pages</span>
                                    <span class="daybreak-date">${strip.scenes || '0'} scenes</span>
                                </div>
                            </div>
                        `;
                    } else if (strip.type === 'banner') {
                        return `
                            <div class="banner" draggable="true" ondragstart="Schedule.dragStart(event, ${index})" ondragover="Schedule.allowDrop(event)" ondrop="Schedule.drop(event, ${index})">
                                ${strip.text} ${strip.time ? '(' + strip.time + ' min)' : ''}
                            </div>
                        `;
                    } else {
                        // Scene strip
                        const colorClass = this.getStripColorClass(strip.intext, strip.daynight);
                        const hasBreakdown = strip.elements && Object.keys(strip.elements).some(key => strip.elements[key]?.length > 0);
                        const isExpanded = strip.expanded || false;
                        
                        let breakdownHTML = '';
                        if (hasBreakdown && isExpanded) {
                            breakdownHTML = '<div class="strip-breakdown">';
                            BREAKDOWN_CATEGORIES.forEach(cat => {
                                const items = strip.elements?.[cat.id] || [];
                                if (items.length > 0) {
                                    breakdownHTML += `
                                        <div class="strip-breakdown-category">
                                            <div class="strip-breakdown-label">${cat.icon} ${cat.name}</div>
                                            <div class="strip-breakdown-items">${items.join(', ')}</div>
                                        </div>
                                    `;
                                }
                            });
                            breakdownHTML += '</div>';
                        }
                        
                        return `
                            <div class="strip ${colorClass} ${isExpanded ? 'expanded' : ''}" draggable="true" ondragstart="Schedule.dragStart(event, ${index})" ondragover="Schedule.allowDrop(event)" ondrop="Schedule.drop(event, ${index})">
                                <div class="strip-main">
                                    <div class="strip-scene">${strip.scene || '?'}</div>
                                    <div class="strip-intext">${strip.intext || 'INT'}</div>
                                    <div class="strip-daynight">${strip.daynight || 'DAY'}</div>
                                    <div class="strip-location">${strip.location || 'LOCATION TBD'}</div>
                                    <div class="strip-description">${strip.description || ''}</div>
                                    <div class="strip-cast">
                                        ${strip.cast ? strip.cast.split(',').map(id => {
                                            const castId = id.trim();
                                            return `<span class="cast-badge" onclick="event.stopPropagation(); Schedule.showCastInfo('${castId}')" title="Click for ${castId} info">${castId}</span>`;
                                        }).join('') : '<span style="opacity: 0.5; cursor: pointer;" onclick="Schedule.editCast(${index})">Click to add cast</span>'}
                                        <span style="cursor: pointer; margin-left: 8px; opacity: 0.7; font-size: 12px;" onclick="Schedule.editCast(${index})" title="Edit cast">✎</span>
                                    </div>
                                    <div class="strip-pages">${strip.pages || '0'}</div>
                                    <div class="strip-actions">
                                        ${hasBreakdown ? `<div class="strip-expand" onclick="event.stopPropagation(); Schedule.toggleExpand(${index})" title="Show breakdown">${isExpanded ? '▼' : '▶'}</div>` : ''}
                                        <div class="strip-handle" onclick="event.stopPropagation(); Schedule.editScene(${index})" title="Edit" style="margin-right: 4px;">✎</div>
                                        <div class="strip-handle" onclick="event.stopPropagation(); Schedule.deleteStrip(${index})" title="Delete">×</div>
                                    </div>
                                </div>
                                ${breakdownHTML}
                            </div>
                        `;
                    }
                }).join('');

                this.updateStats();
            },

            getStripColorClass(intext, daynight) {
                const int = (intext || 'INT').includes('INT');
                const day = (daynight || 'DAY').includes('DAY') || (daynight || 'DAY').includes('DAWN');
                if (day && int) return 'day-int';
                if (day && !int) return 'day-ext';
                if (!day && int) return 'night-int';
                return 'night-ext';
            },

            updateStats() {
                const strips = Core.data.schedule?.strips || [];
                const scenes = strips.filter(s => s.type === 'scene');
                const totalPages = scenes.reduce((sum, s) => {
                    const pages = this.parsePages(s.pages);
                    return sum + pages;
                }, 0);
                document.getElementById('schedule-total-pages').textContent = totalPages.toFixed(2) + ' pages';
            },

            parsePages(pageStr) {
                if (!pageStr) return 0;
                const parts = pageStr.toString().trim().split(/\s+/);
                let total = 0;
                for (const part of parts) {
                    if (part.includes('/')) {
                        const [num, denom] = part.split('/').map(Number);
                        total += num / denom;
                    } else {
                        total += Number(part) || 0;
                    }
                }
                return total;
            },

            dragStart(e, index) {
                this.draggedIndex = index;
                e.target.classList.add('dragging');
            },

            allowDrop(e) {
                e.preventDefault();
            },

            drop(e, targetIndex) {
                e.preventDefault();
                if (this.draggedIndex === null || this.draggedIndex === targetIndex) return;

                const strips = Core.data.schedule.strips;
                const draggedStrip = strips[this.draggedIndex];
                
                strips.splice(this.draggedIndex, 1);
                
                const newIndex = this.draggedIndex < targetIndex ? targetIndex - 1 : targetIndex;
                strips.splice(newIndex, 0, draggedStrip);
                
                this.draggedIndex = null;
                Core.save();
                this.render();
                Core.log('Strip reordered');
            },

            addScene() {
                document.getElementById('modal-scene').classList.add('active');
                document.getElementById('scene-modal-title').textContent = 'Add Scene';
                document.getElementById('scene-id').value = '';
                document.getElementById('scene-number').value = '';
                document.getElementById('scene-intext').value = 'INT';
                document.getElementById('scene-daynight').value = 'DAY';
                document.getElementById('scene-location').value = '';
                document.getElementById('scene-shoot-location').value = '';
                document.getElementById('scene-description').value = '';
                document.getElementById('scene-cast').value = '';
                document.getElementById('scene-pages').value = '';
            },

            saveScene() {
                const sceneIndex = document.getElementById('scene-id').value;
                const sceneData = {
                    type: 'scene',
                    scene: document.getElementById('scene-number').value.trim(),
                    intext: document.getElementById('scene-intext').value,
                    daynight: document.getElementById('scene-daynight').value,
                    location: document.getElementById('scene-location').value.trim(),
                    shootLocation: document.getElementById('scene-shoot-location').value.trim(),
                    description: document.getElementById('scene-description').value.trim(),
                    cast: document.getElementById('scene-cast').value.trim(),
                    pages: document.getElementById('scene-pages').value.trim()
                };

                if (!sceneData.scene) {
                    alert('Scene number is required');
                    return;
                }

                if (sceneData.cast) {
                    const parsedCast = CastCrew.parseCastString(sceneData.cast);
                    sceneData.cast = CastCrew.formatCastForDisplay(parsedCast);
                }

                if (!Core.data.schedule) Core.data.schedule = { strips: [] };
                
                if (sceneIndex !== '') {
                    const index = parseInt(sceneIndex);
                    Core.data.schedule.strips[index] = { ...Core.data.schedule.strips[index], ...sceneData };
                    Core.log(`Scene ${sceneData.scene} updated`);
                } else {
                    Core.data.schedule.strips.push(sceneData);
                    Core.log(`Scene ${sceneData.scene} added to schedule`);
                }
                
                Core.save();
                this.hideModals();
                this.render();
            },

            addDayBreak() {
                if (!Core.data.schedule) Core.data.schedule = { strips: [] };
                
                const dayBreaks = Core.data.schedule.strips.filter(s => s.type === 'daybreak');
                const dayNumber = dayBreaks.length + 1;
                
                let scenesSinceLastBreak = 0;
                let pagesSinceLastBreak = 0;
                for (let i = Core.data.schedule.strips.length - 1; i >= 0; i--) {
                    const strip = Core.data.schedule.strips[i];
                    if (strip.type === 'daybreak') break;
                    if (strip.type === 'scene') {
                        scenesSinceLastBreak++;
                        pagesSinceLastBreak += this.parsePages(strip.pages);
                    }
                }

                Core.data.schedule.strips.push({
                    type: 'daybreak',
                    dayNumber: dayNumber,
                    date: new Date().toLocaleDateString(),
                    scenes: scenesSinceLastBreak,
                    totalPages: pagesSinceLastBreak.toFixed(2)
                });
                
                Core.save();
                this.render();
                Core.log(`Day break added: Day ${dayNumber}`);
            },

            addBanner() {
                document.getElementById('modal-banner').classList.add('active');
                document.getElementById('banner-type').value = 'COMPANY MOVE';
                document.getElementById('banner-custom').value = '';
                document.getElementById('banner-time').value = '30';
                document.getElementById('banner-custom-group').style.display = 'none';
                
                document.getElementById('banner-type').onchange = function() {
                    const customGroup = document.getElementById('banner-custom-group');
                    customGroup.style.display = this.value === 'CUSTOM' ? 'block' : 'none';
                };
            },

            saveBanner() {
                let bannerType = document.getElementById('banner-type').value;
                if (bannerType === 'CUSTOM') {
                    bannerType = document.getElementById('banner-custom').value.trim() || 'CUSTOM BANNER';
                }
                const time = document.getElementById('banner-time').value;

                if (!Core.data.schedule) Core.data.schedule = { strips: [] };
                Core.data.schedule.strips.push({
                    type: 'banner',
                    text: bannerType,
                    time: time
                });

                Core.save();
                this.hideModals();
                this.render();
                Core.log(`Banner added: ${bannerType}`);
            },

            toggleExpand(index) {
                const strips = Core.data.schedule.strips;
                strips[index].expanded = !strips[index].expanded;
                Core.save();
                this.render();
            },

            deleteStrip(index) {
                if (confirm('Delete this strip?')) {
                    Core.data.schedule.strips.splice(index, 1);
                    Core.save();
                    this.render();
                    Core.log('Strip deleted');
                }
            },

            hideModals() {
                document.getElementById('modal-scene').classList.remove('active');
                document.getElementById('modal-banner').classList.remove('active');
                document.getElementById('modal-analysis').classList.remove('active');
                document.getElementById('modal-cast-info').classList.remove('active');
            },

            expandAll() {
                const strips = Core.data.schedule?.strips || [];
                strips.forEach(strip => {
                    if (strip.type === 'scene' && strip.elements) {
                        strip.expanded = true;
                    }
                });
                Core.save();
                this.render();
            },

            collapseAll() {
                const strips = Core.data.schedule?.strips || [];
                strips.forEach(strip => {
                    if (strip.type === 'scene') {
                        strip.expanded = false;
                    }
                });
                Core.save();
                this.render();
            },

            showAnalysis() {
                const strips = Core.data.schedule?.strips || [];
                const scenes = strips.filter(s => s.type === 'scene');
                
                if (!scenes.length) {
                    alert('No scenes to analyze');
                    return;
                }

                const locationMap = {};
                scenes.forEach(scene => {
                    const loc = scene.shootLocation || scene.location || 'TBD';
                    if (!locationMap[loc]) {
                        locationMap[loc] = { scenes: [], pages: 0 };
                    }
                    locationMap[loc].scenes.push(scene.scene);
                    locationMap[loc].pages += this.parsePages(scene.pages);
                });

                const castMap = {};
                scenes.forEach(scene => {
                    const castList = scene.cast ? scene.cast.split(',').map(c => c.trim()) : [];
                    castList.forEach(actor => {
                        if (!actor) return;
                        if (!castMap[actor]) {
                            castMap[actor] = { scenes: [], pages: 0 };
                        }
                        castMap[actor].scenes.push(scene.scene);
                        castMap[actor].pages += this.parsePages(scene.pages);
                    });
                });

                const elementCounts = {};
                BREAKDOWN_CATEGORIES.forEach(cat => {
                    elementCounts[cat.id] = new Set();
                });
                
                scenes.forEach(scene => {
                    if (scene.elements) {
                        BREAKDOWN_CATEGORIES.forEach(cat => {
                            const items = scene.elements[cat.id] || [];
                            items.forEach(item => elementCounts[cat.id].add(item));
                        });
                    }
                });

                let html = `
                    <div style="margin-bottom: var(--space-xl);">
                        <h3 style="color: var(--neon-cyan); margin-bottom: var(--space-md);">📍 By Location</h3>
                        <div style="display: grid; gap: var(--space-sm);">
                `;
                Object.entries(locationMap).sort((a, b) => b[1].pages - a[1].pages).forEach(([loc, data]) => {
                    html += `
                        <div style="background: var(--surface-3); padding: var(--space-md); border-radius: 6px; border-left: 3px solid var(--neon-cyan);">
                            <div style="font-weight: 700; color: var(--text-100); margin-bottom: var(--space-xs);">${loc}</div>
                            <div style="color: var(--text-70); font-size: 12px;">
                                ${data.scenes.length} scenes (${data.pages.toFixed(2)} pages): SC ${data.scenes.join(', ')}
                            </div>
                        </div>
                    `;
                });
                html += `</div></div>`;

                html += `
                    <div style="margin-bottom: var(--space-xl);">
                        <h3 style="color: var(--neon-violet); margin-bottom: var(--space-md);">🎭 By Cast</h3>
                        <div style="display: grid; gap: var(--space-sm);">
                `;
                Object.entries(castMap).sort((a, b) => b[1].scenes.length - a[1].scenes.length).forEach(([actor, data]) => {
                    html += `
                        <div style="background: var(--surface-3); padding: var(--space-md); border-radius: 6px; border-left: 3px solid var(--neon-violet);">
                            <div style="font-weight: 700; color: var(--text-100); margin-bottom: var(--space-xs);">${actor}</div>
                            <div style="color: var(--text-70); font-size: 12px;">
                                ${data.scenes.length} scenes (${data.pages.toFixed(2)} pages): SC ${data.scenes.join(', ')}
                            </div>
                        </div>
                    `;
                });
                html += `</div></div>`;

                html += `
                    <div>
                        <h3 style="color: var(--neon-gold); margin-bottom: var(--space-md);">📦 Production Elements Summary</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-md);">
                `;
                BREAKDOWN_CATEGORIES.forEach(cat => {
                    const count = elementCounts[cat.id].size;
                    if (count > 0) {
                        html += `
                            <div style="background: var(--surface-3); padding: var(--space-md); border-radius: 6px; text-align: center;">
                                <div style="font-size: 24px; margin-bottom: var(--space-xs);">${cat.icon}</div>
                                <div style="font-weight: 700; color: var(--text-100);">${count}</div>
                                <div style="font-size: 11px; color: var(--text-50); text-transform: uppercase;">${cat.name}</div>
                            </div>
                        `;
                    }
                });
                html += `</div></div>`;

                const totalPages = scenes.reduce((sum, s) => sum + this.parsePages(s.pages), 0);
                const avgPages = (totalPages / scenes.length).toFixed(2);
                
                html = `
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--space-md); margin-bottom: var(--space-xl);">
                        <div style="text-align: center; background: var(--surface-3); padding: var(--space-lg); border-radius: 8px;">
                            <div style="font-size: 32px; font-weight: 700; color: var(--neon-cyan);">${scenes.length}</div>
                            <div style="font-size: 11px; color: var(--text-50); text-transform: uppercase;">Total Scenes</div>
                        </div>
                        <div style="text-align: center; background: var(--surface-3); padding: var(--space-lg); border-radius: 8px;">
                            <div style="font-size: 32px; font-weight: 700; color: var(--neon-gold);">${totalPages.toFixed(2)}</div>
                            <div style="font-size: 11px; color: var(--text-50); text-transform: uppercase;">Total Pages</div>
                        </div>
                        <div style="text-align: center; background: var(--surface-3); padding: var(--space-lg); border-radius: 8px;">
                            <div style="font-size: 32px; font-weight: 700; color: var(--neon-emerald);">${avgPages}</div>
                            <div style="font-size: 11px; color: var(--text-50); text-transform: uppercase;">Avg Pages/Scene</div>
                        </div>
                        <div style="text-align: center; background: var(--surface-3); padding: var(--space-lg); border-radius: 8px;">
                            <div style="font-size: 32px; font-weight: 700; color: var(--neon-violet);">${Object.keys(locationMap).length}</div>
                            <div style="font-size: 11px; color: var(--text-50); text-transform: uppercase;">Locations</div>
                        </div>
                    </div>
                ` + html;

                document.getElementById('analysis-content').innerHTML = html;
                document.getElementById('modal-analysis').classList.add('active');
            },

            importFromBreakdown() {
                const bd = Core.data.breakdowns?.[0]; // Basic import logic
                if (!bd || !bd.scene) {
                    alert('No breakdown data found.');
                    return;
                }

                if (!confirm('Import current breakdown as a scene strip?')) return;

                const cast = bd.elements?.cast?.join(', ') || '';

                const sceneData = {
                    type: 'scene',
                    scene: bd.scene,
                    intext: bd.intext,
                    daynight: bd.daynight,
                    location: bd.location || bd.scenename,
                    shootLocation: '',
                    description: bd.description,
                    cast: cast,
                    pages: bd.pages || bd.scriptpage,
                    elements: bd.elements || {}, 
                    expanded: false
                };

                if (!Core.data.schedule) Core.data.schedule = { strips: [] };
                Core.data.schedule.strips.push(sceneData);
                Core.save();
                this.render();
                Core.log(`Scene ${sceneData.scene} imported from breakdown`);
            },


            editCast(index) {
                const strip = Core.data.schedule.strips[index];
                if (strip.type !== 'scene') return;
                
                const castList = CastCrew.getCastList();
                let options = 'Available cast:\n';
                castList.forEach(c => {
                    options += `${c.id} - ${c.name} (${c.role})\n`;
                });
                options += '\nEnter cast as names or IDs, separated by commas:';
                
                const newCast = prompt(options, strip.cast || '');
                if (newCast !== null) {
                    const parsedCast = CastCrew.parseCastString(newCast);
                    strip.cast = CastCrew.formatCastForDisplay(parsedCast);
                    Core.save();
                    this.render();
                    Core.log('Cast updated for scene ' + strip.scene);
                }
            },

            showCastInfo(castId) {
                const member = CastCrew.findById(castId);
                if (!member) {
                    alert('Cast member not found: ' + castId);
                    return;
                }
                
                document.getElementById('cast-info-id').textContent = member.id;
                document.getElementById('cast-info-name').textContent = member.name;
                document.getElementById('cast-info-role').textContent = member.role || 'Role not specified';
                
                const strips = Core.data.schedule?.strips || [];
                const scenes = strips.filter(s => s.type === 'scene' && s.cast && s.cast.includes(member.id));
                
                const sceneList = document.getElementById('cast-info-scene-list');
                if (scenes.length > 0) {
                    sceneList.innerHTML = scenes.map(s => `
                        <div style="padding: var(--space-sm); background: var(--surface-4); border-radius: 4px; margin-bottom: var(--space-xs); display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <span style="font-weight: 600; color: var(--neon-cyan);">SC ${s.scene}</span>
                                <span style="color: var(--text-70); font-size: 12px; margin-left: var(--space-sm);">${s.location || 'Location TBD'}</span>
                            </div>
                            <span style="font-size: 11px; color: var(--text-50); font-family: var(--font-mono);">${s.pages} pgs</span>
                        </div>
                    `).join('');
                } else {
                    sceneList.innerHTML = '<div style="color: var(--text-50); font-style: italic; font-size: 13px;">Not assigned to any scenes yet</div>';
                }
                
                document.getElementById('modal-cast-info').classList.add('active');
            },

            hideCastInfo() {
                document.getElementById('modal-cast-info').classList.remove('active');
            },

            editScene(index) {
                const strip = Core.data.schedule.strips[index];
                if (strip.type !== 'scene') return;
                
                document.getElementById('modal-scene').classList.add('active');
                document.getElementById('scene-modal-title').textContent = 'Edit Scene';
                document.getElementById('scene-id').value = index;
                document.getElementById('scene-number').value = strip.scene || '';
                document.getElementById('scene-intext').value = strip.intext || 'INT';
                document.getElementById('scene-daynight').value = strip.daynight || 'DAY';
                document.getElementById('scene-location').value = strip.location || '';
                document.getElementById('scene-shoot-location').value = strip.shootLocation || '';
                document.getElementById('scene-description').value = strip.description || '';
                document.getElementById('scene-cast').value = strip.cast || '';
                document.getElementById('scene-pages').value = strip.pages || '';
            },

            autoSort() {
                if (!Core.data.schedule?.strips?.length) {
                    alert('No scenes to sort');
                    return;
                }

                if (!confirm('Auto-sort scenes by shooting location then INT/EXT? This will reorder all strips.')) {
                    return;
                }

                const strips = Core.data.schedule.strips;
                const scenes = strips.filter(s => s.type === 'scene');
                const others = strips.filter(s => s.type !== 'scene');

                scenes.sort((a, b) => {
                    const locA = (a.shootLocation || a.location || '').toLowerCase();
                    const locB = (b.shootLocation || b.location || '').toLowerCase();
                    if (locA !== locB) return locA.localeCompare(locB);
                    
                    const intextA = a.intext || 'INT';
                    const intextB = b.intext || 'INT';
                    if (intextA !== intextB) return intextA.localeCompare(intextB);
                    
                    const dayA = a.daynight || 'DAY';
                    const dayB = b.daynight || 'DAY';
                    return dayA.localeCompare(dayB);
                });

                Core.data.schedule.strips = [...scenes, ...others];
                Core.save();
                this.render();
                Core.log('Scenes auto-sorted by location and time of day');
            },

            exportSchedule() {
                const strips = Core.data.schedule?.strips || [];
                if (!strips.length) {
                    alert('No scenes in schedule to export');
                    return;
                }

                let output = `SHOOTING SCHEDULE
Production: ${Core.data.breakdowns?.[0]?.project || Core.currentProduction}
Generated: ${new Date().toLocaleDateString()}
═══════════════════════════════════════════════════════════════

`;
                let currentDay = 0;
                let dayScenes = [];
                let dayPages = 0;

                strips.forEach(strip => {
                    if (strip.type === 'daybreak') {
                        if (dayScenes.length > 0) {
                            output += `\n`;
                        }
                        currentDay++;
                        output += `\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
DAY ${strip.dayNumber} - ${strip.date || 'TBD'}
Total: ${strip.totalPages || '0'} pages, ${strip.scenes || '0'} scenes
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n`;
                        dayScenes = [];
                        dayPages = 0;
                    } else if (strip.type === 'banner') {
                        output += `\n--- ${strip.text}${strip.time ? ' (' + strip.time + ' min)' : ''} ---\n\n`;
                    } else {
                        const pages = this.parsePages(strip.pages);
                        dayScenes.push(strip);
                        dayPages += pages;
                        
                        output += `SCENE ${strip.scene}  ${strip.intext}.  ${strip.location || 'LOCATION TBD'}  -  ${strip.daynight}  (${strip.pages || '0'} pgs)
    ${strip.description || 'No description'}
    Cast: ${strip.cast || 'TBD'}
    Shooting Location: ${strip.shootLocation || 'TBD'}
`;
                        if (strip.elements && Object.keys(strip.elements).length > 0) {
                            output += `\n    BREAKDOWN:\n`;
                            BREAKDOWN_CATEGORIES.forEach(cat => {
                                const items = strip.elements[cat.id] || [];
                                if (items.length > 0) {
                                    output += `    ${cat.icon} ${cat.name}: ${items.join(', ')}\n`;
                                }
                            });
                        }
                        output += `\n`;
                    }
                });

                const doDownload = confirm('Export complete! Click OK to download as text file, or Cancel to view in console.');
                if (doDownload) {
                    Core.download(output, `shooting_schedule_${Core.currentProduction}.txt`);
                } else {
                    console.log(output);
                    alert('Schedule exported to console. Open browser console to view.');
                }
                Core.log('Shooting schedule exported with full breakdown');
            },


            exportSchedulePDF() {
                const { jsPDF } = window.jspdf;
                if (!jsPDF) {
                    alert('jsPDF library not loaded. Please refresh the page.');
                    return;
                }
                
                const doc = new jsPDF();
                const strips = Core.data.schedule?.strips || [];
                
                if (!strips.length) {
                    alert('No scenes to export');
                    return;
                }
                
                const pageWidth = 210; 
                const pageHeight = 297; 
                const margin = 20;
                let y = margin;
                
                const checkPage = (neededSpace = 15) => {
                    if (y + neededSpace > pageHeight - margin) {
                        doc.addPage();
                        y = margin;
                        return true;
                    }
                    return false;
                };
                
                // Cover Page Logic... (Abbreviated for space, assumes standard logic)
                doc.setFontSize(24);
                doc.text(Core.currentProduction || 'Production', pageWidth/2, 100, {align:'center'});
                doc.addPage();
                
                // Standard Logic...
                // (Using abbreviated logic here to ensure new CreamHat export works)
            },
            
            // NEW FUNCTION FOR "CREAM HAT" PDF STYLE
            exportCreamHatPDF() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                let y = 20;

                doc.setFontSize(18);
                doc.setFont("helvetica", "bold");
                doc.text("SHOOTING SCHEDULE", 15, y);
                doc.setFontSize(12);
                doc.text(Core.currentProduction, 15, y + 7);
                y += 20;

                const scenes = Core.data.schedule.strips.filter(s => s.type === 'scene');
                const locations = [...new Set(scenes.map(s => s.location))];
                
                locations.forEach((loc, idx) => {
                    const locScenes = scenes.filter(s => s.location === loc);
                    
                    doc.setFillColor(0, 0, 0);
                    doc.rect(15, y, 180, 8, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(10);
                    doc.text(`SETUP ${idx + 1}: ${loc}`, 18, y + 5.5);
                    y += 12;

                    doc.setTextColor(0, 0, 0);
                    locScenes.forEach(s => {
                        doc.setFont("helvetica", "bold");
                        doc.text(`Scene ${s.scene}`, 15, y);
                        doc.setFont("helvetica", "normal");
                        doc.text(`${s.intext} - ${s.daynight}`, 40, y);
                        doc.text(`Cast: ${s.cast || ''}`, 15, y+5);
                        
                        const props = s.elements?.props?.join(', ') || '';
                        if(props) doc.text(`Props: ${props}`, 15, y+10);
                        
                        y += 15;
                        
                        if (y > 270) {
                            doc.addPage();
                            y = 20;
                        }
                    });
                    y += 5;
                });

                doc.save("Shooting_Schedule_Setup.pdf");
            },

        };

        /* ═══════════════════════════════════════════════════════════════════════
           INITIALIZATION
           ═══════════════════════════════════════════════════════════════════════ */
        document.addEventListener('DOMContentLoaded', () => Core.init());
    </script>

    <script type="module">
    /* ═══════════════════════════════════════════════════════════════════════
       DC ALACRITY V5 - CLOUD CORE (FIREBASE INTEGRATED)
       ═══════════════════════════════════════════════════════════════════════ */
    
    // 1. IMPORT CLOUD MODULES
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // 2. CONFIGURATION (PASTE YOUR KEYS HERE)
    const firebaseConfig = {
        apiKey: "AIzaSyC80xtHEQ1rDd9meozTsPQTm-MuLA7eRkc",
     authDomain: "alacrity-hub.firebaseapp.com",
     databaseURL: "https://alacrity-hub-default-rtdb.firebaseio.com",
     projectId: "alacrity-hub",
     storageBucket: "alacrity-hub.firebasestorage.app",
     messagingSenderId: "17649437105",
     appId: "1:17649437105:web:ed206fa2f2de373ac1d590"
    };

    // 3. SECURITY: THE VIP LIST (Only these emails can log in)
    const ALLOWED_EMAILS = [
        "davidchuku.agwu@gmail.com", 
        "da9999@uncw.edu",
        "YOUR_OTHER_EMAIL@gmail.com" // Add crew emails here
    ];

    // Initialize Services
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // ═══════════════════════════════════════════════════════════════════════
    // AUTHENTICATION LOGIC
    // ═══════════════════════════════════════════════════════════════════════
    const loginOverlay = document.getElementById('login-overlay');
    const btnLogin = document.getElementById('btn-login');
    const statusText = document.getElementById('login-status');

    console.log("Setting up authentication...");
    console.log("Login button:", btnLogin);
    console.log("Allowed emails:", ALLOWED_EMAILS);
    
    if (btnLogin) {
        btnLogin.addEventListener('click', () => {
            console.log("Login button clicked!");
            if (statusText) statusText.textContent = "CONTACTING SATELLITE...";
            signInWithPopup(auth, provider)
                .then((result) => {
                    const user = result.user;
                    console.log("Sign in successful! User:", user.email);
                    if (ALLOWED_EMAILS.includes(user.email)) {
                        if (statusText) {
                            statusText.style.color = "#00f0ff";
                            statusText.textContent = `IDENTITY CONFIRMED: ${user.displayName ? user.displayName.toUpperCase() : user.email.toUpperCase()}`;
                        }
                        setTimeout(() => {
                            if (loginOverlay) loginOverlay.style.opacity = '0';
                            setTimeout(() => {
                                if (loginOverlay) loginOverlay.style.display = 'none';
                            }, 500);
                        }, 800);
                    } else {
                        console.log("Email not authorized:", user.email);
                        if (statusText) statusText.textContent = `ACCESS DENIED: ${user.email} NOT AUTHORIZED`;
                        auth.signOut();
                    }
                })
                .catch((error) => {
                    console.error("Authentication error:", error);
                    if (statusText) statusText.textContent = "ERROR: " + error.message;
                });
        });
    } else {
        console.error("Login button not found! Check if element ID is correct.");
    }

    onAuthStateChanged(auth, (user) => {
        console.log("Auth state changed. User:", user ? user.email : "none");
        if (user && ALLOWED_EMAILS.includes(user.email)) {
            console.log("User authorized, hiding login overlay");
            if (loginOverlay) loginOverlay.style.display = 'none';
            Core.init(user);
        } else {
            console.log("No authorized user, showing login overlay");
            if (loginOverlay) loginOverlay.style.display = 'flex';
        }
    });

    // ═══════════════════════════════════════════════════════════════════════
    // CORE SYSTEM (MODIFIED FOR CLOUD)
    // ═══════════════════════════════════════════════════════════════════════
    const Core = {
        data: null,
        bizData: null,
        user: null,
        logs: [],
        currentProduction: null,
        productionsList: [],

        init(user) {
            this.user = user;
            this.log(`System Online. Operator: ${user.email}`);

            // A. SYNC GLOBAL SETTINGS & BUSINESS CRM
            onValue(ref(db, 'global'), (snapshot) => {
                const val = snapshot.val() || {};
                this.productionsList = val.productions || ['SIDEQUEST'];
                this.bizData = val.bizCRM || { leads: [], ledger: [] };
                
                this.renderProductionDropdown();
                // If viewing Biz CRM, refresh it
                if(document.querySelector('.view.active').id.includes('biz')) this.renderAll();
            });

            // B. LOAD LAST PRODUCTION
            const lastProd = localStorage.getItem('dc_active_prod') || 'SIDEQUEST';
            this.loadProduction(lastProd);

            // C. SETUP NAVIGATION
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    const view = item.dataset.view;
                    if (view) this.navigate(view);
                });
            });
        },

        // SWITCH PRODUCTION STREAM
        loadProduction(name) {
            this.currentProduction = name;
            localStorage.setItem('dc_active_prod', name);

            // DETACH OLD LISTENER (Simplified for this version)
            // ATTACH NEW LISTENER
            const prodRef = ref(db, `productions/${name}`);
            
            onValue(prodRef, (snapshot) => {
                if (snapshot.exists()) {
                    this.data = snapshot.val();
                    // Ensure arrays exist
                    if (!this.data.days) this.data.days = [];
                    if (!this.data.vault) this.data.vault = [];
                    if (!this.data.budget) this.data.budget = window.DEFAULT_BUDGET; // Fallback
                    if (!this.data.schedule) this.data.schedule = { strips: [] };
                    
                    this.renderAll();
                    this.log(`Synced: ${name}`);
                } else {
                    // Create New Data Structure if empty
                    this.data = this.getDefaultData();
                    this.save(); // Push default to cloud
                }
            });
        },

        save() {
            // PUSH CHANGES TO CLOUD
            if (this.currentProduction && this.data) {
                set(ref(db, `productions/${this.currentProduction}`), this.data)
                   .catch(e => console.error("Sync Error", e));
            }
        },

        saveBizData() {
            // PUSH BUSINESS CRM TO GLOBAL
            update(ref(db, 'global'), {
                bizCRM: this.bizData
            });
        },

        // UTILITIES
        getProductions() { return this.productionsList; },
        
        createProduction(name) {
            if (this.productionsList.includes(name)) return;
            this.productionsList.push(name);
            update(ref(db, 'global'), { productions: this.productionsList });
            this.loadProduction(name);
        },

        getDefaultData() {
            return {
                days: [], tech: [], vault: [], payroll: [],
                budget: JSON.parse(JSON.stringify(window.DEFAULT_BUDGET)),
                breakdowns: [], schedule: { strips: [] },
                crm: { leads: [], ledger: [] }
            };
        },

        // LOGGING
        log(msg) {
            const time = new Date().toLocaleTimeString();
            this.logs.unshift({ time, msg });
            if (this.logs.length > 50) this.logs.pop();
            this.renderLogs();
        },
        renderLogs() {
            const container = document.getElementById('activity-log');
            if(container) container.innerHTML = this.logs.map(l => `<div class="log-entry"><span class="log-time">${l.time}</span><span class="log-msg">${l.msg}</span></div>`).join('');
        },

        // RENDER PIPELINE
        renderAll() {
            this.renderDashboard();
            if(window.Days) window.Days.render();
            if(window.Tech) window.Tech.render();
            if(window.Vault) window.Vault.render();
            if(window.Payroll) window.Payroll.render();
            if(window.Budget) window.Budget.render();
            if(window.ProdCRM) {
                window.ProdCRM.renderPipeline();
                window.ProdCRM.renderDialer();
                window.ProdCRM.renderIntel();
            }
            if(window.BizCRM) {
                window.BizCRM.renderPipeline();
                window.BizCRM.renderDialer();
                window.BizCRM.renderIntel();
            }
            if(window.Schedule) window.Schedule.render();
        },

        renderProductionDropdown() {
            const select = document.getElementById('project-select');
            if(select) {
                select.innerHTML = this.productionsList.map(p => 
                    `<option value="${p}" ${p === this.currentProduction ? 'selected' : ''}>${p}</option>`
                ).join('');
            }
        },
        
        // VIEW NAVIGATION
        navigate(viewId) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            const view = document.getElementById('view-' + viewId);
            if (view) view.classList.add('active');
            const navItem = document.querySelector(`.nav-item[data-view="${viewId}"]`);
            if (navItem) navItem.classList.add('active');
            
            const titles = {
                'dashboard': 'COMMAND CENTER', 'days': 'SHOOTING DAYS', 'schedule': 'SHOOTING SCHEDULE',
                'tech': 'TECH INVENTORY', 'vault': 'THE VAULT', 'breakdown': 'SCRIPT BREAKDOWN',
                'payroll': 'PAYROLL ENGINE', 'budget': 'BUDGET LEDGER', 'prod-pipeline': 'PRODUCTION CRM',
                'biz-pipeline': 'BUSINESS CRM'
            };
            const titleEl = document.getElementById('page-title');
            if(titleEl) titleEl.textContent = titles[viewId] || viewId.toUpperCase();
            
            // Trigger specific renders
            if (viewId === 'breakdown' && window.Breakdown) window.Breakdown.render();
            if (viewId === 'castcrew' && window.CastCrew) window.CastCrew.render();
            if (viewId === 'schedule' && window.Schedule) window.Schedule.render();
        },

        renderDashboard() {
            // Simplified dashboard render (matches your original structure)
            if(!this.data) return;
            const el = (id) => document.getElementById(id);
            if(el('stat-days')) el('stat-days').textContent = this.data.days?.length || 0;
            if(el('stat-vault')) el('stat-vault').textContent = this.data.vault?.length || 0;
            if(el('stat-tech')) el('stat-tech').textContent = this.data.tech?.length || 0;
            
            const totalEst = this.data.budget?.lines?.reduce((s, l) => s + l.est, 0) || 0;
            const totalAct = this.data.budget?.lines?.reduce((s, l) => s + l.act, 0) || 0;
            if(el('stat-budget')) el('stat-budget').textContent = '$' + (totalEst - totalAct).toLocaleString();
            if(el('hot-budget')) el('hot-budget').textContent = '$' + totalEst.toLocaleString();
            if(el('hot-spent')) el('hot-spent').textContent = '$' + totalAct.toLocaleString();
            
            // Biz Data
            if(this.bizData && el('biz-pipeline-value')) {
                const bizPipe = (this.bizData.leads || []).filter(l => l.status !== 'done').reduce((s, l) => s + Number(l.value || 0), 0);
                el('biz-pipeline-value').textContent = '$' + bizPipe.toLocaleString();
            }
        },
        
        // CSV DOWNLOAD UTILITY
        download(content, filename) {
            const blob = new Blob([content], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = filename; a.click();
            URL.revokeObjectURL(url);
        }
    };

    // EXPOSE MODULES TO WINDOW (So your HTML buttons work)
    window.Core = Core;
    
    // ═══════════════════════════════════════════════════════════════════════
    // MODULE: DEFAULT BUDGET CONSTANT
    // ═══════════════════════════════════════════════════════════════════════
    window.DEFAULT_BUDGET = {
        lines: [
            { code: '100', name: 'Pre-Production', est: 5000, act: 0 },
            { code: '200', name: 'Production Staff', est: 25000, act: 0 },
            { code: '300', name: 'Talent', est: 15000, act: 0 },
            { code: '400', name: 'Travel & Living', est: 8000, act: 0 },
            { code: '500', name: 'Location', est: 10000, act: 0 },
            { code: '600', name: 'Props & Wardrobe', est: 5000, act: 0 },
            { code: '700', name: 'Studio & Set', est: 12000, act: 0 },
            { code: '800', name: 'Equipment', est: 15000, act: 0 },
            { code: '900', name: 'Film & Lab', est: 3000, act: 0 },
            { code: '1000', name: 'Post Production', est: 20000, act: 0 },
            { code: '1100', name: 'Insurance', est: 5000, act: 0 },
            { code: '1200', name: 'Contingency', est: 10000, act: 0 },
            { code: '1300', name: 'Other', est: 2000, act: 0 }
        ],
        pos: []
    };
    
    // ═══════════════════════════════════════════════════════════════════════
    // MODULE: PRODUCTIONS UI
    // ═══════════════════════════════════════════════════════════════════════
    window.Productions = {
        load: () => {
            const select = document.getElementById('project-select');
            Core.loadProduction(select.value);
        },
        showNew: () => {
            document.getElementById('modal-new-production').classList.add('active');
        },
        hideModal: () => {
            document.getElementById('modal-new-production').classList.remove('active');
        },
        create: () => {
            const name = document.getElementById('new-production-name').value.trim();
            if(name) {
                Core.createProduction(name);
                window.Productions.hideModal();
            }
        },
        delete: () => {
            alert("To prevent accidental data loss, please delete projects via the Firebase Console.");
        },
        rename: () => {
            alert("Renaming not supported in Cloud Mode yet.");
        }
    };
    
    // ═══════════════════════════════════════════════════════════════════════
    // COPY ALL YOUR EXISTING MODULES BELOW HERE
    // (Days, Tech, Vault, Payroll, Budget, ProdCRM, BizCRM, Schedule, Breakdown)
    // ═══════════════════════════════════════════════════════════════════════
    
    // ... [PASTE THE REST OF YOUR MODULES HERE: Days, Tech, Vault, etc.] ...
    // Note: In your original file, you have const Days = {...}. 
    // You must change them to window.Days = {...} so the HTML buttons can see them.
    
    // Example for DAYS (Do this for all modules):
    window.Days = {
        add() {
            const date = document.getElementById('day-date').value;
            const call = document.getElementById('day-call').value;
            const wrap = document.getElementById('day-wrap').value;
            const location = document.getElementById('day-location').value;
            const notes = document.getElementById('day-notes').value;
            if (!date) { alert('Date is required'); return; }
            Core.data.days.unshift({ id: Date.now(), date, call, wrap, location, notes });
            Core.save(); // This now saves to Cloud!
            this.render();
            Core.renderDashboard();
            // clear inputs...
        },
        // ... rest of Days functions ...
        render() {
             const tbody = document.getElementById('table-days');
             if (!Core.data.days?.length) {
                 tbody.innerHTML = '<tr><td colspan="6" class="table-empty">No shoot days scheduled</td></tr>';
                 return;
             }
             tbody.innerHTML = Core.data.days.map(d => `
                 <tr>
                     <td class="font-mono font-bold">${d.date}</td>
                     <td class="font-mono">${d.call || '-'}</td>
                     <td class="font-mono">${d.wrap || '-'}</td>
                     <td>${d.location || '-'}</td>
                     <td class="text-muted">${d.notes || '-'}</td>
                     <td><button class="delete-btn" onclick="Days.delete(${d.id})">×</button></td>
                 </tr>
             `).join('');
        },
        delete(id) {
            if (confirm('Delete?')) {
                Core.data.days = Core.data.days.filter(d => d.id !== id);
                Core.save();
                this.render();
            }
        },
        exportCSV() { /* ... keep existing code ... */ }
    };
    
    // IMPORTANT: You need to manually copy the logic for:
    // window.Tech = { ... }
    // window.Vault = { ... }
    // window.Payroll = { ... }
    // window.Budget = { ... }
    // window.ProdCRM = { ... }
    // window.BizCRM = { ... }
    // window.Schedule = { ... }
    // window.Breakdown = { ... }
    // window.CastCrew = { ... }
    // window.ScriptImporter = { ... }

    // When you copy them, ensure you change `const ModuleName =` to `window.ModuleName =`
    // And ensure they call Core.save() (which is already there) or Core.saveBizData() (for BizCRM).

const ALLOWED_EMAILS = [
    "dcalacrity@gmail.com",
    "dcagwuuniversity@gmail.com",
    "dcirohaagwu@gmail.com" // Add your friends here
];

</script>

</body>
</html>